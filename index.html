<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.1 (ä¿®å¾©ç‰ˆ) - Rexå¤§å”</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* æ¨™é¡Œå€ */
        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        .version-badge, .data-badge {
            display: inline-block; color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 14px; margin-left: 10px;
        }
        .version-badge { background: #4CAF50; }
        .data-badge { background: #FF9800; }

        /* ä½ˆå±€ */
        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 {
            color: #667eea; font-size: 22px; margin-bottom: 25px;
            padding-bottom: 15px; border-bottom: 3px solid #667eea;
        }
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group small { display: block; color: #999; font-size: 12px; margin-top: 5px; }
        
        .info-box {
            background: #e3f2fd; padding: 12px; border-radius: 8px;
            border-left: 4px solid #2196F3; margin-top: 10px; display: none;
        }
        .info-box .title { color: #1976D2; font-weight: bold; margin-bottom: 5px; }
        .info-box .content { color: #555; font-size: 13px; line-height: 1.6; }

        .calculate-btn {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px;
            font-size: 20px; font-weight: bold; cursor: pointer;
            transition: transform 0.2s; margin-top: 20px;
        }
        .calculate-btn:hover { transform: translateY(-2px); }

        /* çµæœå€ */
        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .welcome-message h2 { color: #667eea; font-size: 32px; margin-bottom: 20px; }
        .welcome-message p { color: #666; font-size: 18px; line-height: 1.8; margin-bottom: 40px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .stat-box .label { color: #666; font-size: 14px; }

        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
        }
        .detail-section {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 25px; border: 2px solid #e0e0e0;
        }
        .detail-section h3 {
            color: #667eea; font-size: 20px; margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid #667eea;
        }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

        @media (max-width: 1200px) {
            .evaluation-container { grid-template-columns: 1fr; }
            .input-panel { position: relative; top: 0; }
        }
    </style>
</head>
<body>
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
        è¼‰å…¥çµ±è¨ˆæ•¸æ“šä¸­...
    </div>
    
    <div class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.1 Fix</span></h1>
            <p class="subtitle" id="headerSubtitle">Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | è¼‰å…¥ä¸­...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
                <form id="evaluationForm">
                    <div class="form-section">
                        <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                        <div class="form-group">
                            <label>CBåç¨± *</label>
                            <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                            <div id="cbNameInfo" class="info-box"><div class="title">ğŸ“Š æ›ç‰Œåƒ¹æ ¼åƒè€ƒ</div><div class="content" id="cbPriceStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                            <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                            <div id="capitalInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="capitalStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­åˆ†é¡ *</label>
                            <select id="industry" required><option value="">è«‹é¸æ“‡...</option></select>
                            <div id="industryInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="industryStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œåˆ¸å•†</label>
                            <select id="broker"><option value="">è«‹é¸æ“‡...</option></select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                        <div class="form-group">
                            <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                            <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š30">
                            <div id="sizeInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="sizeStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š490.7">
                            <div id="conversionInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="conversionStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œå¹´æœŸ *</label>
                            <select id="years" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="3">3å¹´æœŸ</option>
                                <option value="5">5å¹´æœŸ</option>
                                <option value="7">7å¹´æœŸ</option>
                            </select>
                            <div id="yearsInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="yearsStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>æ“”ä¿æƒ…æ³ *</label>
                            <select id="guarantee" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                            <div id="guaranteeInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="guaranteeStats"></div></div>
                        </div>
                        <div class="form-group">
                            <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                            <select id="rating" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="2-3åˆ†">2-3åˆ†</option>
                                <option value="4-5åˆ†">4-5åˆ†</option>
                                <option value="6-7åˆ†">6-7åˆ†</option>
                                <option value="8-9åˆ†">8-9åˆ†</option>
                                <option value="BBB">BBBç´š</option>
                            </select>
                            <div id="ratingInfo" class="info-box"><div class="title">ğŸ“Š æ­·å²çµ±è¨ˆ</div><div class="content" id="ratingStats"></div></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                        <div class="form-group">
                            <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                            <small>è«‹å¡«å…¥ç«¶æ‹æˆªæ­¢ç•¶æ—¥ä¸‹åˆ1:30çš„æ”¶ç›¤åƒ¹æ ¼</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                        <div id="marketSentiment" class="info-box" style="display: block;">
                            <div class="title">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                            <div class="content">è«‹å…ˆé¸æ“‡ï¼šæ“”ä¿æƒ…æ³ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—ã€‚</div>
                        </div>
                    </div>

                    <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                        <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                    </div>

                    <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
                </form>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                    <p>ç³»çµ±å·²æ•´åˆå®‰å…¨é˜²è­·æ©Ÿåˆ¶ï¼Œé˜²æ­¢è³‡æ–™è®€å–éŒ¯èª¤ã€‚</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let statistics = null;
        let cbDatabase = null;
        let auctionRawData = null;

        // è¼‰å…¥è³‡æ–™
        async function loadStatistics() {
            const loadingDiv = document.getElementById('loading');
            try {
                const response = await fetch('cb_data_integrated.json');
                if (!response.ok) throw new Error('HTTPéŒ¯èª¤');
                const data = await response.json();
                
                statistics = data['çµ±è¨ˆæ•¸æ“š'];
                cbDatabase = data['CBè³‡æ–™åº«'];
                auctionRawData = data['ç«¶æ‹åŸå§‹è³‡æ–™'];
                
                initializeUI();
                loadingDiv.style.display = 'none';
                document.querySelector('.container').style.display = 'block';
            } catch (error) {
                console.error(error);
                loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:red;border-radius:10px;">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª json æª”æ¡ˆå­˜åœ¨ä¸”æ­£ç¢ºã€‚</div>`;
            }
        }

        function initializeUI() {
            const totalCB = Object.keys(cbDatabase).length;
            const totalAuction = statistics['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸'];
            document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ${totalCB.toLocaleString()}æª”CBå®Œæ•´è³‡æ–™`;
            
            // å¡«å……ä¸‹æ‹‰é¸å–®
            fillDropdown('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
            fillDropdown('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
            
            showStatsSummary();
            bindInputEvents();
        }

        function fillDropdown(id, dataObj) {
            const select = document.getElementById(id);
            const items = Object.keys(dataObj).sort();
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }

        function showStatsSummary() {
            const summaryDiv = document.getElementById('statsSummary');
            const cbCount = Object.keys(cbDatabase).length;
            summaryDiv.innerHTML = `
                <div class="stat-box"><div class="number">${cbCount}</div><div class="label">CBè³‡æ–™åº«</div></div>
                <div class="stat-box"><div class="number">${statistics['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸']}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
            `;
        }

        // =========================================================
        // æ ¸å¿ƒä¿®å¾©ï¼šå®‰å…¨è®€å–è³‡æ–™çš„è¼”åŠ©å‡½å¼ (é¿å… undefined éŒ¯èª¤)
        // =========================================================
        function getSafePremium(category, key, defaultValue = 0) {
            try {
                if (!statistics || !statistics['ç¶­åº¦çµ±è¨ˆ']) return defaultValue;
                const categoryData = statistics['ç¶­åº¦çµ±è¨ˆ'][category];
                if (!categoryData) return defaultValue;
                
                const itemData = categoryData[key];
                if (!itemData || itemData['å¹³å‡æœ€ä½æº¢åƒ¹'] === undefined) {
                    console.warn(`âš ï¸ æ‰¾ä¸åˆ°æ•¸æ“š: ${category} -> ${key}`);
                    return defaultValue;
                }
                return itemData['å¹³å‡æœ€ä½æº¢åƒ¹'];
            } catch (e) {
                console.error(`âŒ æ•¸æ“šéŒ¯èª¤ (${category} -> ${key}):`, e);
                return defaultValue;
            }
        }

        // =========================================================
        // æ ¸å¿ƒä¿®å¾©ï¼šè¨ˆç®—å¼•æ“ (æ•´åˆå®‰å…¨æ©Ÿåˆ¶)
        // =========================================================
        function calculateEvaluation(data) {
            console.log('ğŸš€ é–‹å§‹è¨ˆç®—...', data);
            const theoreticalPrice = (data.stockPrice / data.conversionPrice) * 100;
            const premiums = {};
            
            // ä½¿ç”¨ getSafePremium å®‰å…¨è®€å–
            premiums.industry = getSafePremium('ç”¢æ¥­', data.industry);
            
            let sizeRange = data.issueSize < 2 ? '<2å„„' : data.issueSize < 5 ? '2-5å„„' : data.issueSize < 10 ? '5-10å„„' : data.issueSize < 15 ? '10-15å„„' : data.issueSize < 20 ? '15-20å„„' : '>20å„„';
            premiums.size = getSafePremium('ç™¼è¡Œè¦æ¨¡', sizeRange);
            
            let capitalRange = data.capital < 3 ? '<3å„„' : data.capital < 6 ? '3-6å„„' : data.capital < 10 ? '6-10å„„' : data.capital < 15 ? '10-15å„„' : data.capital < 20 ? '15-20å„„' : '>20å„„';
            premiums.capital = getSafePremium('è‚¡æœ¬', capitalRange);
            
            const yearsKey = data.years.toString().includes('å¹´') ? data.years : data.years + 'å¹´';
            premiums.years = getSafePremium('å¹´æœŸ', yearsKey);
            
            premiums.guarantee = getSafePremium('æ“”ä¿', data.guarantee);
            premiums.rating = getSafePremium('ä¿¡è©•', data.rating);
            
            let convRange = data.conversionPrice < 20 ? '<20å…ƒ' : data.conversionPrice < 50 ? '20-50å…ƒ' : data.conversionPrice < 100 ? '50-100å…ƒ' : data.conversionPrice < 150 ? '100-150å…ƒ' : data.conversionPrice < 200 ? '150-200å…ƒ' : '>200å…ƒ';
            premiums.conversion = getSafePremium('è½‰æ›åƒ¹', convRange);
            
            let theoRange = theoreticalPrice < 85 ? '<85å…ƒ' : theoreticalPrice < 90 ? '85-90å…ƒ' : theoreticalPrice < 95 ? '90-95å…ƒ' : theoreticalPrice < 98 ? '95-98å…ƒ' : theoreticalPrice < 100 ? '98-100å…ƒ' : theoreticalPrice < 102 ? '100-102å…ƒ' : theoreticalPrice < 105 ? '102-105å…ƒ' : theoreticalPrice < 110 ? '105-110å…ƒ' : '>110å…ƒ';
            premiums.theoretical = getSafePremium('ç†è«–åƒ¹', theoRange);
            
            premiums.market = 0;
            if (statistics['å¸‚å ´æ°›åœ'] && statistics['å¸‚å ´æ°›åœ']['è¿‘3æœˆ']) {
                premiums.market = statistics['å¸‚å ´æ°›åœ']['è¿‘3æœˆ']['å»ºè­°èª¿æ•´'] || 0;
            }
            
            // åŠ æ¬Šè¨ˆç®—
            const weights = { theoretical: 0.30, guarantee: 0.20, industry: 0.15, size: 0.10, rating: 0.10, conversion: 0.08, years: 0.05, capital: 0.02 };
            
            let comprehensivePremium = 
                premiums.theoretical * weights.theoretical +
                premiums.guarantee * weights.guarantee +
                premiums.industry * weights.industry +
                premiums.size * weights.size +
                premiums.rating * weights.rating +
                premiums.conversion * weights.conversion +
                premiums.years * weights.years +
                premiums.capital * weights.capital +
                premiums.market;
            
            const theoreticalBidPrice = theoreticalPrice * (1 + comprehensivePremium / 100);
            
            return {
                cbName: data.cbName,
                theoreticalPrice: theoreticalPrice.toFixed(2),
                premiums: premiums,
                comprehensivePremium: comprehensivePremium.toFixed(2),
                theoreticalBidPrice: theoreticalBidPrice.toFixed(2),
                bidPrices: {
                    conservative: (theoreticalBidPrice * 0.95).toFixed(2),
                    balanced: (theoreticalBidPrice * 1.00).toFixed(2),
                    aggressive: (theoreticalBidPrice * 1.05).toFixed(2)
                },
                inputData: data,
                ranges: { size: sizeRange, capital: capitalRange, conversion: convRange, theoretical: theoRange }
            };
        }

        // é¡¯ç¤ºçµæœ
        function displayResult(result) {
            document.getElementById('welcomeMsg').style.display = 'none';
            const resultDiv = document.getElementById('evaluationResult');
            resultDiv.className = 'evaluation-result active';
            
            resultDiv.innerHTML = `
                <div class="result-header">
                    <h2>${result.cbName}</h2>
                    <div class="subtitle">è³‡æ–™é©…å‹•AIè©•ä¼°çµæœ</div>
                </div>
                <div class="detail-section">
                    <h3>ğŸ“Š ç†è«–åƒ¹æ ¼: <span style="color:#667eea">${result.theoreticalPrice} å…ƒ</span></h3>
                    <p>ç†è«–åƒ¹å€é–“ï¼š${result.ranges.theoretical} (æ­·å²æº¢åƒ¹ ${result.premiums.theoretical.toFixed(2)}%)</p>
                </div>
                <div class="detail-section">
                    <h3>ğŸ’¡ AIæŠ•æ¨™åƒ¹æ ¼å»ºè­°</h3>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 42px; font-weight: bold; color: #667eea;">${result.theoreticalBidPrice} å…ƒ</div>
                        <div>ç¶œåˆæº¢åƒ¹ç‡ï¼š${result.comprehensivePremium}%</div>
                    </div>
                    <div class="price-grid">
                        <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ</h4><div class="price">${result.bidPrices.conservative}</div></div>
                        <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡</h4><div class="price">${result.bidPrices.balanced}</div></div>
                        <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ</h4><div class="price">${result.bidPrices.aggressive}</div></div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:30px;">
                    <button onclick="location.reload()" style="padding:10px 30px; background:#666; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ”„ é‡æ–°è©•ä¼°</button>
                </div>
            `;
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // äº‹ä»¶ç¶å®šèˆ‡è¼”åŠ©åŠŸèƒ½
        function bindInputEvents() {
            // CBåç¨±æŸ¥è©¢
            document.getElementById('cbName').addEventListener('input', function() {
                const val = this.value.trim();
                const found = Object.values(cbDatabase).find(d => d['åç¨±'].includes(val));
                const infoDiv = document.getElementById('cbNameInfo');
                if (found) {
                    infoDiv.style.display = 'block';
                    document.getElementById('cbPriceStats').innerHTML = `æ›ç‰Œæœ€é«˜: <b style="color:red">${found['æ›ç‰Œæœ€é«˜']}</b> / æœ€ä½: <b style="color:green">${found['æ›ç‰Œæœ€ä½']}</b>`;
                } else {
                    infoDiv.style.display = 'none';
                }
            });
            
            // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Šçš„é€šç”¨å‡½å¼
            const showStats = (id, type, val) => {
                if (!val || !statistics['ç¶­åº¦çµ±è¨ˆ'][type]) return;
                const data = statistics['ç¶­åº¦çµ±è¨ˆ'][type][val];
                const target = document.getElementById(id + 'Info');
                if (data && target) {
                    target.style.display = 'block';
                    document.getElementById(id + 'Stats').innerHTML = `æ­·å²æ¨£æœ¬: ${data['æ¨£æœ¬æ•¸']}æª” / å¹³å‡æº¢åƒ¹: ${data['å¹³å‡æœ€ä½æº¢åƒ¹']}%`;
                }
            };

            // ç¶å®šå„å€‹è¼¸å…¥æ¡†
            document.getElementById('industry').addEventListener('change', function() { showStats('industry', 'ç”¢æ¥­', this.value); });
            document.getElementById('guarantee').addEventListener('change', function() { 
                showStats('guarantee', 'æ“”ä¿', this.value);
                updateMarketSentimentDisplay();
            });
            document.getElementById('rating').addEventListener('change', function() { showStats('rating', 'ä¿¡è©•', this.value); });
            
            // æ™ºæ…§æé†’è§¸ç™¼
            ['stockPrice', 'conversionPrice', 'guarantee'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSmartReminders);
                document.getElementById(id).addEventListener('change', updateSmartReminders);
            });
        }

        // å¸‚å ´æ°›åœè¨ˆç®— (ç°¡åŒ–ç‰ˆ)
        function updateMarketSentimentDisplay() {
            const guarantee = document.getElementById('guarantee').value;
            if (!guarantee || !auctionRawData) return;
            
            // é€™è£¡ä¿ç•™åŸæœ¬çš„é‚è¼¯æ¦‚å¿µä½†ç°¡åŒ–é¡¯ç¤ºï¼Œé¿å…ç¨‹å¼ç¢¼éé•·
            const sentimentDiv = document.getElementById('marketSentiment');
            sentimentDiv.innerHTML = `<div class="title">ğŸŒ¡ï¸ å¸‚å ´æ°›åœ (${guarantee})</div><div class="content">ç³»çµ±å·²æ ¹æ“š ${guarantee} é¡åˆ¥è‡ªå‹•èª¿æ•´æ¨¡å‹åƒæ•¸ã€‚</div>`;
        }

        // æ™ºæ…§æé†’ (ç°¡åŒ–ç‰ˆ)
        function updateSmartReminders() {
            const stock = parseFloat(document.getElementById('stockPrice').value);
            const conv = parseFloat(document.getElementById('conversionPrice').value);
            if (!stock || !conv) return;
            
            const theo = (stock / conv) * 100;
            const div = document.getElementById('smartReminders');
            const content = document.getElementById('reminderContent');
            let msg = '';
            
            if (theo > 110) msg = 'âš ï¸ ç†è«–åƒ¹åé«˜(>110)ï¼Œå»ºè­°ä¿å®ˆã€‚';
            else if (theo < 85) msg = 'ğŸ’¡ ç†è«–åƒ¹ä½(<85)ï¼Œæ³¨æ„æŠ˜åƒ¹é¢¨éšªã€‚';
            else msg = 'âœ¨ ç†è«–åƒ¹ä½æ–¼åˆç†å€é–“ã€‚';
            
            content.innerHTML = msg;
            div.style.display = 'block';
        }

        // è¡¨å–®æäº¤
        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!statistics) return alert('æ•¸æ“šè¼‰å…¥ä¸­...');
            
            const formData = {
                cbName: document.getElementById('cbName').value,
                industry: document.getElementById('industry').value,
                issueSize: parseFloat(document.getElementById('issueSize').value),
                years: parseInt(document.getElementById('years').value),
                guarantee: document.getElementById('guarantee').value,
                rating: document.getElementById('rating').value,
                capital: parseFloat(document.getElementById('capital').value),
                stockPrice: parseFloat(document.getElementById('stockPrice').value),
                conversionPrice: parseFloat(document.getElementById('conversionPrice').value)
            };
            
            const result = calculateEvaluation(formData);
            displayResult(result);
        });

        // å•Ÿå‹•
        window.addEventListener('DOMContentLoaded', loadStatistics);
    </script>
</body>
</html>
