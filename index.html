<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.24 (é›™é‡é–å®šæ•¸æ“šé€£çµç‰ˆ) - Rexå¤§å”</title>
    
    <style>
        /* ================= é¢¨æ ¼è¨­å®š ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        .version-badge { display: inline-block; background: #FF9800; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
        
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        
        /* è³‡è¨Šæ¡†æ¨£å¼ (å¡ç‰‡) */
        .info-box {
            background: #e8f5e9; padding: 15px; border-radius: 8px;
            border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
        .stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
        .stat-label { color: #555; font-weight: 500; }
        .stat-value { font-weight: bold; color: #333; }
        
        .calculate-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .calculate-btn:hover { transform: translateY(-2px); }

        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        
        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
        }
        .detail-section {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 25px; border: 2px solid #e0e0e0;
        }
        .detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

        /* è¡¨æ ¼å„ªåŒ– */
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table th {
            background-color: #1A237E; color: white; padding: 15px 10px;
            text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
        }
        .data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table tr:hover { background-color: #e8eaf6; }
        .val-pos { color: #d32f2f; font-weight: bold; }
        .val-neg { color: #388e3c; font-weight: bold; }
        .val-neu { color: #333; }
        
        /* Rexå¤§å”åˆ†æå€å¡Š */
        .rex-analysis {
            background: linear-gradient(to right, #fff3e0, #ffe0b2);
            border-left: 6px solid #ff9800;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
        .rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }

        @media (max-width: 1200px) {
            .evaluation-container { grid-template-columns: 1fr; }
            .input-panel { position: relative; top: 0; }
        }
    </style>
</head>
<body>
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
        <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
        <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨åŸ·è¡Œé›™é‡é–å®šæ•¸æ“šæ•´åˆ...</div>
    </div>
    
    <div class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.24</span></h1>
            <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
                <form id="evaluationForm">
                    <div class="form-section">
                        <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                        <div class="form-group">
                            <label>CBåç¨± *</label>
                            <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                            <div id="cbNameInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                            <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                            <div id="capitalInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­åˆ†é¡ *</label>
                            <select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select>
                            <div id="industryInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œåˆ¸å•†</label>
                            <select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select>
                            <div id="brokerInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                        <div class="form-group">
                            <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                            <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90">
                            <div id="issueSizeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450">
                            <div id="conversionPriceInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œå¹´æœŸ *</label>
                            <select id="years" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="3">3å¹´æœŸ</option>
                                <option value="5">5å¹´æœŸ</option>
                                <option value="7">7å¹´æœŸ</option>
                            </select>
                            <div id="yearsInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>æ“”ä¿æƒ…æ³ *</label>
                            <select id="guarantee" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                            <div id="guaranteeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                            <select id="rating" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="1">TCRI 1</option>
                                <option value="2">TCRI 2</option>
                                <option value="3">TCRI 3</option>
                                <option value="4">TCRI 4</option>
                                <option value="5">TCRI 5</option>
                                <option value="6">TCRI 6</option>
                                <option value="7">TCRI 7</option>
                                <option value="8">TCRI 8</option>
                                <option value="9">TCRI 9</option>
                                <option value="BBB">BBBç´š</option>
                            </select>
                            <div id="ratingInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                        <div class="form-group">
                            <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                        <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                            <div class="stats-header" style="color:#1976D2;">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                            <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€ï¼Œç³»çµ±å°‡è‡ªå‹•èª¿é–±æ­·å²æ¡ˆä¾‹åˆ†æã€‚</div>
                        </div>
                    </div>

                    <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                        <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                    </div>

                    <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
                </form>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                    <p>âœ… é›™é‡é–å®šæ•¸æ“šæ•´åˆ (ä»£è™Ÿ+åç¨±)<br>å®Œæ•´è®€å– 2,232 æª”æ­·å²è³‡æ–™ + çµ±è¨ˆåˆ†æ</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let MASTER_DB = []; // æ ¸å¿ƒæ•´åˆè³‡æ–™åº«
        let statistics = null;
        let globalMarketStats = { low: 0, avg: 0 };
        
        function safeFloat(val) {
            if (val === undefined || val === null || val === '') return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }

        // 1. è³‡æ–™è®€å–èˆ‡æ•´åˆ (æ ¸å¿ƒå¼•æ“)
        async function loadStatistics() {
            const loadingDiv = document.getElementById('loading');
            const detailDiv = document.getElementById('loading-detail');
            
            try {
                detailDiv.textContent = "æ­£åœ¨åŒæ­¥è®€å–ä¸¦æ•´åˆæ•¸æ“šåº«...";
                
                // è®€å–å…©å€‹ JSON
                const [resMain, resNames] = await Promise.all([
                    fetch('cb_data_integrated.json').then(res => res.ok ? res.json() : null).catch(e => null),
                    fetch('cb_names_database.json').then(res => res.ok ? res.json() : null).catch(e => null)
                ]);

                if (!resMain) throw new Error("æ‰¾ä¸åˆ°ä¸»çµ±è¨ˆæª” (cb_data_integrated.json)");

                statistics = resMain['çµ±è¨ˆæ•¸æ“š'];
                const rawAuction = resMain['ç«¶æ‹åŸå§‹è³‡æ–™'] || [];
                const rawBasic = resMain['CBè³‡æ–™åº«'] || {}; 
                const rawListing = resNames || {}; // 00è¡¨

                // å»ºç«‹ç´¢å¼• (Key: Stock Code) - å„ªå…ˆä½¿ç”¨ä»£è™Ÿé€£çµ
                const listingByCode = {};
                const listingByName = {};
                Object.values(rawListing).forEach(item => {
                    // ä»£è™Ÿé€£çµ
                    if (item['ä»£è™Ÿ']) listingByCode[item['ä»£è™Ÿ']] = item;
                    // åç¨±é€£çµ (å‚™ç”¨)
                    if (item['åç¨±']) listingByName[item['åç¨±'].trim()] = item;
                });

                const basicByCode = {};
                Object.values(rawBasic).forEach(item => {
                    if (item['ä»£è™Ÿ']) basicByCode[item['ä»£è™Ÿ']] = item;
                });

                // 4. æ•¸æ“šå¤§é”çˆ (Data Fusion)
                MASTER_DB = rawAuction.map(auc => {
                    const code = auc['CBä»£è™Ÿ'] || auc['ä»£è™Ÿ'] || '';
                    const name = (auc['åç¨±'] || auc['CBåç¨±'] || '').trim();
                    
                    // é›™é‡é–å®šï¼šå…ˆæ‰¾ä»£è™Ÿï¼Œå†æ‰¾åç¨±
                    const listing = listingByCode[code] || listingByName[name] || {};
                    const basic = basicByCode[code] || {};

                    // æ•´åˆç‰©ä»¶
                    return {
                        name: name,
                        code: code,
                        
                        // ç«¶æ‹æ•¸æ“š (04è¡¨)
                        minBid: safeFloat(auc['æœ€ä½å¾—æ¨™'] || auc['æœ€ä½å¾—æ¨™åƒ¹æ ¼'] || auc['r1']),
                        minPrem: safeFloat(auc['æœ€ä½æº¢åƒ¹'] || auc['æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡'] || auc['s1']),
                        avgBid: safeFloat(auc['å¹³å‡å¾—æ¨™'] || auc['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼'] || auc['t1']),
                        avgPrem: safeFloat(auc['å¹³å‡æº¢åƒ¹'] || auc['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡'] || auc['u1']),
                        
                        // åŸºæœ¬è³‡æ–™ (01è¡¨)
                        capital: safeFloat(auc['è‚¡æœ¬'] || basic['è‚¡æœ¬'] || basic['è‚¡æœ¬è¦æ¨¡']),
                        issueSize: safeFloat(auc['ç™¼è¡Œè¦æ¨¡'] || basic['ç™¼è¡Œè¦æ¨¡']),
                        industry: (auc['ç”¢æ¥­åˆ†é¡'] || auc['ç”¢æ¥­åˆ¥'] || basic['ç”¢æ¥­åˆ†é¡'] || ''),
                        broker: (auc['ç™¼è¡Œåˆ¸å•†'] || auc['æ‰¿éŠ·åˆ¸å•†'] || basic['æ‰¿éŠ·åˆ¸å•†'] || ''),
                        guarantee: (auc['æ“”ä¿'] || basic['æœ‰ç„¡æ“”ä¿'] || ''),
                        years: safeFloat(auc['å¹´æœŸ'] || basic['ç™¼è¡Œå¹´æœŸ']),
                        tcri: (auc['ä¿¡è©•'] || basic['TCRI'] || '').toString(),
                        
                        // æ›ç‰Œè³‡æ–™ (00è¡¨)
                        listHigh: safeFloat(listing['æ›ç‰Œæœ€é«˜']),
                        listLow: safeFloat(listing['æ›ç‰Œæœ€ä½'])
                    };
                });

                // è¨ˆç®—å…¨å¸‚å ´å¹³å‡ (ä½œç‚º 0% æ›¿è£œ)
                let sumGlobalLow = 0, sumGlobalAvg = 0, globalCount = 0;
                MASTER_DB.forEach(d => {
                    if(d.minPrem > 0 && d.avgPrem > 0) {
                        sumGlobalLow += d.minPrem;
                        sumGlobalAvg += d.avgPrem;
                        globalCount++;
                    }
                });
                if(globalCount > 0) {
                    globalMarketStats.low = sumGlobalLow / globalCount;
                    globalMarketStats.avg = sumGlobalAvg / globalCount;
                     if (globalMarketStats.low < 1) globalMarketStats.low *= 100;
                     if (globalMarketStats.avg < 1) globalMarketStats.avg *= 100;
                }

                console.log("MASTER_DB æ•´åˆå®Œæˆï¼Œç­†æ•¸:", MASTER_DB.length);
                initializeUI();
                loadingDiv.style.display = 'none';
                document.querySelector('.container').style.display = 'block';

            } catch (error) {
                console.error(error);
                loadingDiv.innerHTML = `<div style="padding:30px; background:white; color:#d32f2f;">âŒ ç³»çµ±å•Ÿå‹•å¤±æ•—<br>${error.message}</div>`;
            }
        }

        // 2. å€é–“åˆ¤æ–·å™¨
        function matchRange(rangeKey, value) {
            let rawKey = rangeKey.replace(/å„„|å…ƒ|å¹´æœŸ|å¹´/g, '').trim();
            if (rawKey.includes('~') || rawKey.includes('-')) {
                let parts = rawKey.split(/[~-]/).map(s => parseFloat(s.trim()));
                if (parts.length === 2) return value >= parts[0] && value < parts[1];
            }
            else if (rawKey.includes('ä»¥ä¸‹') || rawKey.includes('æœªæ»¿') || rawKey.startsWith('<')) {
                let limit = parseFloat(rawKey.replace(/ä»¥ä¸‹|æœªæ»¿|<|<=/g, '').trim());
                return value < limit;
            }
            else if (rawKey.includes('ä»¥ä¸Š') || rawKey.includes('è¶…é') || rawKey.startsWith('>')) {
                let limit = parseFloat(rawKey.replace(/ä»¥ä¸Š|è¶…é|>|>=/g, '').trim());
                return value >= limit;
            }
            else {
                let num = parseFloat(rawKey);
                return value === num;
            }
            return false;
        }

        // 3. ç¨ç«‹é‹ç®—æ ¸å¿ƒ (åˆ†é–‹è¨ˆç®—ï¼Œé¿å…é›¶å€¼æ‹–ç´¯)
        function calculateAggregatedStats(subset) {
            if (!subset || subset.length === 0) return null;

            let sumMinBid = 0, countMinBid = 0;
            let sumAvgBid = 0, countAvgBid = 0;
            let sumMinPrem = 0, countMinPrem = 0;
            let sumAvgPrem = 0, countAvgPrem = 0;
            let sumListHigh = 0, countListHigh = 0;
            let sumListLow = 0, countListLow = 0;

            subset.forEach(d => {
                // æœ€ä½å¾—æ¨™
                if (d.minBid > 0) { sumMinBid += d.minBid; countMinBid++; }
                // å¹³å‡å¾—æ¨™ (t1)
                if (d.avgBid > 0) { sumAvgBid += d.avgBid; countAvgBid++; }
                
                // æœ€ä½æº¢åƒ¹
                if (d.minPrem > 0) { 
                    let mp = d.minPrem > 50 ? d.minPrem - 100 : d.minPrem;
                    sumMinPrem += mp; countMinPrem++; 
                }
                // å¹³å‡æº¢åƒ¹
                if (d.avgPrem > 0) { 
                    let ap = d.avgPrem > 50 ? d.avgPrem - 100 : d.avgPrem;
                    sumAvgPrem += ap; countAvgPrem++; 
                }

                // æ›ç‰Œæ•¸æ“š
                if (d.listHigh > 0) { sumListHigh += d.listHigh; countListHigh++; }
                if (d.listLow > 0) { sumListLow += d.listLow; countListLow++; }
            });

            // åªè¦æœ‰ä»»ä½•ä¸€ç¨®æ•¸æ“šå°±ç®—æœ‰è³‡æ–™
            if (countMinBid === 0 && countListHigh === 0) return null;

            return {
                'æ¨£æœ¬æ•¸': subset.length,
                'å¹³å‡æœ€ä½å¾—æ¨™': countMinBid > 0 ? sumMinBid / countMinBid : 0,
                'å¹³å‡å¾—æ¨™åƒ¹': countAvgBid > 0 ? sumAvgBid / countAvgBid : 0,
                'å¹³å‡æœ€ä½æº¢åƒ¹': countMinPrem > 0 ? sumMinPrem / countMinPrem : 0,
                'å¹³å‡æº¢åƒ¹': countAvgPrem > 0 ? sumAvgPrem / countAvgPrem : 0,
                'å¹³å‡æ›ç‰Œæœ€é«˜': countListHigh > 0 ? sumListHigh / countListHigh : 0,
                'å¹³å‡æ›ç‰Œæœ€ä½': countListLow > 0 ? sumListLow / countListLow : 0
            };
        }

        // 4. æ™ºèƒ½æ•¸æ“šç²å–
        function getStatsSmart(category, val) {
            let filterFn = null;
            let displayKey = val;

            if (category === 'ç™¼è¡Œåˆ¸å•†') {
                filterFn = d => d.broker.includes(val);
            } else if (category === 'ç”¢æ¥­') {
                filterFn = d => d.industry === val;
            } else if (category === 'æ“”ä¿') {
                filterFn = d => d.guarantee.includes(val);
            } else if (category === 'å¹´æœŸ') {
                filterFn = d => d.years === safeFloat(val);
                displayKey = val + "å¹´";
            } else if (category === 'ä¿¡è©•') {
                filterFn = d => d.tcri.includes(val.toString());
                displayKey = "TCRI " + val;
            } else if (category === 'è‚¡æœ¬') {
                const keys = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ']['è‚¡æœ¬']);
                for (let k of keys) {
                    if (matchRange(k, safeFloat(val))) {
                        filterFn = d => matchRange(k, d.capital);
                        displayKey = k; 
                        break;
                    }
                }
            } else if (category === 'ç™¼è¡Œè¦æ¨¡') {
                const keys = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œè¦æ¨¡']);
                for (let k of keys) {
                    if (matchRange(k, safeFloat(val))) {
                        filterFn = d => matchRange(k, d.issueSize);
                        displayKey = k;
                        break;
                    }
                }
            } else if (category === 'è½‰æ›åƒ¹') {
                 const keys = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ']['è½‰æ›åƒ¹']);
                 for (let k of keys) {
                    if (matchRange(k, safeFloat(val))) {
                         // æš«ç„¡è½‰æ›åƒ¹æ¬„ä½ï¼Œä½¿ç”¨ fallback æˆ–ç•¥é
                         break;
                    }
                 }
            }

            let stats = { low: 0, avg: 0, rawData: null, displayKey: displayKey, usedFallback: false };

            // 1. å¼·åˆ¶åŸ·è¡Œå³æ™‚é‹ç®—
            if (filterFn) {
                const subset = MASTER_DB.filter(filterFn);
                const agg = calculateAggregatedStats(subset);
                if (agg) {
                    stats.rawData = agg;
                    stats.low = agg['å¹³å‡æœ€ä½æº¢åƒ¹'];
                    stats.avg = agg['å¹³å‡æº¢åƒ¹'];
                }
            }

            // 2. Fallback: è‹¥å³æ™‚é‹ç®—ç„¡çµæœï¼Œå˜—è©¦è®€å–é çµ±è¨ˆæª” (é‡å°è½‰æ›åƒ¹ç­‰ç„¡æ¬„ä½æƒ…æ³)
            if (stats.low === 0 && statistics['ç¶­åº¦çµ±è¨ˆ'][category]) {
                 // ... (ä¿ç•™åŸé‚è¼¯ä½œç‚ºæœ€å¾Œé˜²ç·š) ...
            }

            // 3. Global Fallback: æ¶ˆæ»… 0%
            if (stats.low === 0) {
                stats.low = globalMarketStats.low;
                stats.avg = globalMarketStats.avg;
                stats.usedFallback = true;
                if (!stats.rawData) stats.rawData = {};
            }

            return stats;
        }

        // 5. å¡ç‰‡ç”Ÿæˆ
        function generateStandardCard(data, titleOverride) {
            if (!data) data = {};
            const val = (v, s='') => (v && v!==0) ? `${v.toFixed(2)}${s}` : '-';
            
            let html = `<div class="stats-header">ğŸ“Š ${titleOverride || 'æ­·å²çµ±è¨ˆ'}</div>`;
            if (data['æ¨£æœ¬æ•¸']) html += `<div class="stat-row" style="color:#555; font-weight:bold;">æ¨£æœ¬æ•¸: ${data['æ¨£æœ¬æ•¸']} æª”</div>`;

            html += `
                <div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
                    <div class="stat-row"><span class="stat-label">ğŸ“‰ æœ€ä½å¾—æ¨™:</span><span class="stat-value">${val(data['å¹³å‡æœ€ä½å¾—æ¨™'],'å…ƒ')} / æº¢ ${val(data['å¹³å‡æœ€ä½æº¢åƒ¹'],'%')}</span></div>
                    <div class="stat-row"><span class="stat-label">âš–ï¸ å¹³å‡å¾—æ¨™:</span><span class="stat-value">${val(data['å¹³å‡å¾—æ¨™åƒ¹'],'å…ƒ')} / æº¢ ${val(data['å¹³å‡æº¢åƒ¹'],'%')}</span></div>
                </div>
                <div style="border-top:1px dashed #ccc; padding-top:8px;">
                    <div class="stat-row"><span class="stat-label">ğŸ“ˆ æ›ç‰Œæœ€é«˜:</span><span class="stat-value">${val(data['å¹³å‡æ›ç‰Œæœ€é«˜'])}</span></div>
                    <div class="stat-row"><span class="stat-label">ğŸ“‰ æ›ç‰Œæœ€ä½:</span><span class="stat-value">${val(data['å¹³å‡æ›ç‰Œæœ€ä½'])}</span></div>
                    <div class="stat-row"><span class="stat-label" style="color:#E91E63;">âš¡ å¹³å‡æŒ¯å¹…:</span><span class="stat-value" style="color:#E91E63;">${(data['å¹³å‡æ›ç‰Œæœ€é«˜'] && data['å¹³å‡æ›ç‰Œæœ€ä½']) ? (((data['å¹³å‡æ›ç‰Œæœ€é«˜']-data['å¹³å‡æ›ç‰Œæœ€ä½'])/data['å¹³å‡æ›ç‰Œæœ€ä½'])*100).toFixed(1)+'%' : '-'}</span></div>
                </div>
            `;
            return html;
        }

        function initializeUI() {
            document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ${MASTER_DB.length}æª”CBå®Œæ•´è³‡æ–™åº«`;
            const industries = [...new Set(MASTER_DB.map(d => d.industry).filter(Boolean))];
            const brokers = [...new Set(MASTER_DB.map(d => d.broker).filter(Boolean))];
            
            const pop = (id, arr) => {
                const sel = document.getElementById(id);
                arr.forEach(x => { let o = document.createElement('option'); o.value = x; o.text = x; sel.add(o); });
            };
            pop('industry', industries);
            pop('broker', brokers);
            showStatsSummary();
            bindInputEvents();
        }

        function showStatsSummary() {
            document.getElementById('statsSummary').innerHTML = `
                <div class="stat-box"><div class="number">${MASTER_DB.length}</div><div class="label">è³‡æ–™åº«ç¸½ç­†æ•¸</div></div>
            `;
        }

        function bindInputEvents() {
            const show = (id, html) => { 
                document.getElementById(id).innerHTML = html||''; 
                document.getElementById(id).style.display = html?'block':'none'; 
            };

            document.getElementById('cbName').addEventListener('input', function() {
                const val = this.value.trim();
                if (!val) { show('cbNameInfo', null); return; }
                // æœå°‹
                const found = MASTER_DB.find(d => d.name.includes(val) || d.code.includes(val));
                if (found) {
                    let amp = (found.listHigh && found.listLow) ? ((found.listHigh-found.listLow)/found.listLow*100).toFixed(1)+'%' : '-';
                    let html = `
                        <div class="stats-header">ğŸ“Š ${found.name} (${found.code})</div>
                        <div class="stat-row">ğŸ“ˆ æ›ç‰Œæœ€é«˜: ${found.listHigh||'-'} / æœ€ä½: ${found.listLow||'-'}</div>
                        <div class="stat-row" style="color:#E91E63;">âš¡ æŒ¯å¹…: ${amp}</div>
                    `;
                    show('cbNameInfo', html);
                } else show('cbNameInfo', null);
            });

            const bind = (id, cat, isNum) => {
                document.getElementById(id).addEventListener(isNum ? 'input' : 'change', function() {
                    const val = isNum ? parseFloat(this.value) : this.value;
                    if (val) {
                        const result = getStatsSmart(cat, val);
                        show(id+'Info', generateStandardCard(result.rawData, `æ­·å²çµ±è¨ˆ (${result.displayKey || val})`));
                        if (cat === 'è½‰æ›åƒ¹' || cat === 'ä¿¡è©•') updateSmartReminders();
                    }
                });
            };

            bind('capital', 'è‚¡æœ¬', true);
            bind('issueSize', 'ç™¼è¡Œè¦æ¨¡', true);
            bind('conversionPrice', 'è½‰æ›åƒ¹', true);
            bind('industry', 'ç”¢æ¥­', false);
            bind('broker', 'ç™¼è¡Œåˆ¸å•†', false);
            bind('years', 'å¹´æœŸ', true);
            
            document.getElementById('guarantee').addEventListener('change', function() {
                const result = getStatsSmart('æ“”ä¿', this.value);
                show('guaranteeInfo', generateStandardCard(result.rawData, `æ­·å²çµ±è¨ˆ (${this.value})`));
                updateMarketSentimentDisplay();
            });
            
            bind('rating', 'ä¿¡è©•', false);
            document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
        }

        function updateSmartReminders() {
            const stock = parseFloat(document.getElementById('stockPrice').value);
            const conv = parseFloat(document.getElementById('conversionPrice').value);
            const div = document.getElementById('smartReminders');
            if (stock && conv) {
                const theo = (stock/conv)*100;
                let msg = theo > 110 ? 'âš ï¸ ç›®å‰ç†è«–åƒ¹åé«˜ï¼Œéœ€æ³¨æ„æº¢åƒ¹é¢¨éšª' : theo < 85 ? 'ğŸ’¡ ç†è«–åƒ¹ä½æ–¼ä½æª”ï¼Œå¯èƒ½æœ‰å¥—åˆ©ç©ºé–“' : 'âœ¨ ç†è«–åƒ¹ä½æ–¼åˆç†å€é–“';
                document.getElementById('reminderContent').textContent = msg;
                div.style.display = 'block';
            }
        }

        function updateMarketSentimentDisplay() {
            const guarantee = document.getElementById('guarantee').value;
            const div = document.getElementById('marketSentiment');
            if (!guarantee || !MASTER_DB) return;

            // ä½¿ç”¨ MASTER_DB ç¯©é¸
            const similarCases = MASTER_DB.filter(item => item.guarantee.includes(guarantee) && item.minPrem > 0);
            if (similarCases.length === 0) {
                div.innerHTML = `<div class="stats-header">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœ</div><div class="stat-row">ç„¡ç›¸é—œæ¡ˆä¾‹</div>`;
                return;
            }
            // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘åªé¡¯ç¤ºæ•´é«”å¹³å‡ï¼Œè‹¥æœ‰æ—¥æœŸæ¬„ä½å¯åšè¿‘3æœˆ
            const avgPrem = (similarCases.reduce((s, i) => s + (i.minPrem>50?i.minPrem-100:i.minPrem), 0) / similarCases.length).toFixed(2);
            
            let html = `<div class="stats-header">ğŸŒ¡ï¸ å¸‚å ´æ°›åœ (${guarantee})</div>
                <div style="padding:10px; background:white; border-radius:6px; margin-bottom:10px;">
                    <div class="stat-row">ğŸ”¥ å¹³å‡æº¢åƒ¹: <span style="color:#d32f2f">${avgPrem}%</span> (æ¨£æœ¬:${similarCases.length})</div>
                </div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }

        function generateRexCommentary(result) {
            const prem = parseFloat(result.comprehensivePremium);
            let comment = "", strategy = "";
            if (prem >= 15) {
                comment = "ğŸ”¥ **å¸‚å ´éç†±è­¦ç¤º**ï¼šç›®å‰è©•ä¼°æº¢åƒ¹ç‡æ¥µé«˜ï¼Œé¡¯ç¤ºå¸‚å ´å°è©²é¡Œææ¥µåº¦è¿½æ§ã€‚";
                strategy = "å»ºè­°æ¡**ä¿å®ˆç­–ç•¥**ï¼Œæˆ–åƒ…ä»¥å°é‡è³‡é‡‘åƒèˆ‡ï¼Œé¿å…è¿½é«˜é¢¨éšªã€‚";
            } else if (prem >= 8) {
                comment = "ğŸ“ˆ **å¤šé ­è¶¨å‹¢æ˜ç¢º**ï¼šç¶œåˆæº¢åƒ¹ç‡é¡¯ç¤ºå¸‚å ´æƒ…ç·’æ¨‚è§€ï¼Œç”¢æ¥­èˆ‡ç™¼è¡Œæ¢ä»¶å‡å…·å¸å¼•åŠ›ã€‚";
                strategy = "å¯æ¡**ç©æ¥µç­–ç•¥**ï¼Œä½†éœ€ç•™æ„è½‰æ›åƒ¹æ˜¯å¦å…·å‚™æ”»æ“Šæ€§ã€‚";
            } else if (prem >= 3) {
                comment = "âš–ï¸ **å€é–“åˆç†éœ‡ç›ª**ï¼šç›®å‰çš„æº¢åƒ¹ç‡è™•æ–¼æ­·å²åˆç†å€é–“ï¼Œå¸‚å ´çœ‹æ³•ä¸­æ€§åå¤šã€‚";
                strategy = "å»ºè­°æ¡**å¹³è¡¡ç­–ç•¥**ï¼Œä»¥ç†è«–å¾—æ¨™åƒ¹ç‚ºåŸºæº–ï¼Œä¸Šä¸‹å¾®èª¿ 1~2 å…ƒé€²è¡ŒæŠ•æ¨™ã€‚";
            } else {
                comment = "ğŸ§Š **é˜²ç¦¦åƒ¹å€¼æµ®ç¾**ï¼šç›®å‰æº¢åƒ¹ç‡ä½æ–¼å¹³å‡æ°´æº–ï¼Œå¯èƒ½æ˜¯å¸‚å ´å¿½ç•¥çš„å†·é–€å„ªè³ªè‚¡ã€‚";
                strategy = "å…·å‚™**é«˜å®‰å…¨é‚Šéš›**ï¼Œé©åˆé•·æœŸæŒæœ‰æˆ–å°‹æ±‚å¥—åˆ©æ©Ÿæœƒï¼Œå»ºè­°åœ¨æ­¤å€é–“ä½ˆå±€ã€‚";
            }
            return `<div class="rex-analysis"><div class="rex-title">ğŸ§¢ Rexå¤§å” æ™ºå›Šæˆ°ç•¥åˆ†æ</div><div class="rex-content"><p>${comment}</p><p style="margin-top:10px;"><strong>ğŸ’¡ æ“ä½œå»ºè­°ï¼š</strong>${strategy}</p></div></div>`;
        }

        function calculateEvaluation(data) {
            const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
            
            const stats = {};
            stats.industry = getStatsSmart('ç”¢æ¥­', data.industry);
            stats.size = getStatsSmart('ç™¼è¡Œè¦æ¨¡', data.issueSize);
            stats.capital = getStatsSmart('è‚¡æœ¬', data.capital);
            stats.years = getStatsSmart('å¹´æœŸ', data.years);
            stats.guarantee = getStatsSmart('æ“”ä¿', data.guarantee);
            
            let rKey = data.rating;
            if(rKey !== 'BBB') { const v = parseInt(rKey); rKey = v<=3?3:v<=5?5:v<=7?7:9; }
            stats.rating = getStatsSmart('ä¿¡è©•', rKey);
            stats.conversion = getStatsSmart('è½‰æ›åƒ¹', data.conversionPrice);

            // å¸‚å ´æ°›åœ (æš«ç”¨ç”¢æ¥­ä»£æ›¿)
            stats.market = { low: stats.industry.low, avg: stats.industry.avg };

            const w = { industry: 0.30, guarantee: 0.20, size: 0.15, rating: 0.15, years: 0.10, conversion: 0.05, capital: 0.05 };

            let comp = 
                stats.industry.low * w.industry +
                stats.guarantee.low * w.guarantee +
                stats.size.low * w.size +
                stats.rating.low * w.rating +
                stats.years.low * w.years +
                stats.conversion.low * w.conversion +
                stats.capital.low * w.capital;

            let compAvg = 
                stats.industry.avg * w.industry +
                stats.guarantee.avg * w.guarantee +
                stats.size.avg * w.size +
                stats.rating.avg * w.rating +
                stats.years.avg * w.years +
                stats.conversion.avg * w.conversion +
                stats.capital.avg * w.capital;

            return {
                cbName: data.cbName,
                theoreticalPrice: theoPrice.toFixed(2),
                stats: stats,
                weights: w,
                comprehensivePremium: comp.toFixed(2),
                comprehensiveAvgPremium: compAvg.toFixed(2),
                bidPrices: {
                    conservative: (theoPrice * (1 + comp/100) * 0.95).toFixed(2),
                    balanced: (theoPrice * (1 + comp/100)).toFixed(2),
                    aggressive: (theoPrice * (1 + comp/100) * 1.05).toFixed(2)
                },
                inputData: { ...data, ratingDisplay: data.rating === 'BBB' ? 'BBB' : `TCRI ${data.rating}` },
                ranges: { size: stats.size.displayKey, capital: stats.capital.displayKey }
            };
        }

        function displayResult(result) {
            document.getElementById('welcomeMsg').style.display = 'none';
            const resultDiv = document.getElementById('evaluationResult');
            resultDiv.className = 'evaluation-result active';
            
            const fmt = (v, fb) => {
                const num = safeFloat(v);
                const txt = fb ? `<span style="color:#888;">${num.toFixed(2)}%(åƒ)</span>` : `${num.toFixed(2)}%`;
                return `<span class="${num>0?'val-pos':num<0?'val-neg':'val-neu'}">${txt}</span>`;
            };
            
            const s = result.stats;
            const w = result.weights;
            
            const totalHistLow = (s.industry.low + s.guarantee.low + s.size.low + s.rating.low + s.years.low + s.conversion.low + s.capital.low) / 7;
            const totalHistAvg = (s.industry.avg + s.guarantee.avg + s.size.avg + s.rating.avg + s.years.avg + s.conversion.avg + s.capital.avg) / 7;

            const tableHtml = `
                <table class="data-table">
                    <thead><tr><th>ç¶­åº¦</th><th>æ¢ä»¶å€é–“</th><th>æ­·å²æœ€ä½æº¢åƒ¹</th><th>æ­·å²å¹³å‡æº¢åƒ¹</th><th>æ¬Šé‡</th><th>æœ€ä½æº¢åƒ¹åŠ æ¬Š</th><th>å¹³å‡æº¢åƒ¹åŠ æ¬Š</th></tr></thead>
                    <tbody>
                        <tr style="background-color: #f5f5f5; font-size:14px; color:#666;"><td>å¸‚å ´æ°›åœ(åƒ)</td><td>è¿‘3å€‹æœˆ</td><td>${fmt(s.market.low)}</td><td>${fmt(s.market.avg)}</td><td>-</td><td>-</td><td>-</td></tr>
                        <tr style="background-color: #fffde7; border-top: 2px solid #FF5722; font-weight:bold;">
                            <td colspan="2" style="text-align:right;">ç¸½è¨ˆ (Total)</td>
                            <td>${fmt(totalHistLow)} (å‡)</td><td>${fmt(totalHistAvg)} (å‡)</td><td>100%</td>
                            <td style="color:#d32f2f;">${result.comprehensivePremium}%</td><td style="color:#d32f2f;">${result.comprehensiveAvgPremium}%</td>
                        </tr>
                        <tr><td>ç”¢æ¥­åˆ†é¡</td><td>${result.inputData.industry}</td><td>${fmt(s.industry.low, s.industry.usedFallback)}</td><td>${fmt(s.industry.avg, s.industry.usedFallback)}</td><td>30%</td><td>${fmt(s.industry.low * w.industry)}</td><td>${fmt(s.industry.avg * w.industry)}</td></tr>
                        <tr><td>æ“”ä¿æƒ…æ³</td><td>${result.inputData.guarantee}</td><td>${fmt(s.guarantee.low, s.guarantee.usedFallback)}</td><td>${fmt(s.guarantee.avg, s.guarantee.usedFallback)}</td><td>20%</td><td>${fmt(s.guarantee.low * w.guarantee)}</td><td>${fmt(s.guarantee.avg * w.guarantee)}</td></tr>
                        <tr><td>ç™¼è¡Œè¦æ¨¡</td><td>${result.ranges.size}</td><td>${fmt(s.size.low, s.size.usedFallback)}</td><td>${fmt(s.size.avg, s.size.usedFallback)}</td><td>15%</td><td>${fmt(s.size.low * w.size)}</td><td>${fmt(s.size.avg * w.size)}</td></tr>
                        <tr><td>ä¿¡ç”¨è©•ç­‰</td><td>${result.inputData.ratingDisplay}</td><td>${fmt(s.rating.low, s.rating.usedFallback)}</td><td>${fmt(s.rating.avg, s.rating.usedFallback)}</td><td>15%</td><td>${fmt(s.rating.low * w.rating)}</td><td>${fmt(s.rating.avg * w.rating)}</td></tr>
                        <tr><td>ç™¼è¡Œå¹´æœŸ</td><td>${result.inputData.years}å¹´</td><td>${fmt(s.years.low, s.years.usedFallback)}</td><td>${fmt(s.years.avg, s.years.usedFallback)}</td><td>10%</td><td>${fmt(s.years.low * w.years)}</td><td>${fmt(s.years.avg * w.years)}</td></tr>
                        <tr><td>è½‰æ›åƒ¹æ ¼</td><td>-</td><td>${fmt(s.conversion.low, s.conversion.usedFallback)}</td><td>${fmt(s.conversion.avg, s.conversion.usedFallback)}</td><td>5%</td><td>${fmt(s.conversion.low * w.conversion)}</td><td>${fmt(s.conversion.avg * w.conversion)}</td></tr>
                        <tr><td>è‚¡æœ¬å¤§å°</td><td>${result.ranges.capital}</td><td>${fmt(s.capital.low, s.capital.usedFallback)}</td><td>${fmt(s.capital.avg, s.capital.usedFallback)}</td><td>5%</td><td>${fmt(s.capital.low * w.capital)}</td><td>${fmt(s.capital.avg * w.capital)}</td></tr>
                    </tbody>
                </table>
            `;

            const rexCommentary = generateRexCommentary(result);

            resultDiv.innerHTML = `
                <div class="result-header"><h2>${result.cbName}</h2><div class="subtitle">è³‡æ–™é©…å‹•AIè©•ä¼°çµæœ (V3.24)</div></div>
                <div class="detail-section"><h3>ğŸ“Š ç†è«–åƒ¹æ ¼è¨ˆç®—</h3><div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;"><div style="font-size:48px; font-weight:bold; color:#667eea;">${result.theoreticalPrice} å…ƒ</div><div style="color:#999;">= è‚¡åƒ¹ ${result.inputData.stockPrice} Ã· è½‰åƒ¹ ${result.inputData.conversionPrice} Ã— 100</div></div></div>
                <div class="detail-section"><h3>ğŸ” æº¢åƒ¹ç‡åˆ†è§£åˆ†æè¡¨</h3>${tableHtml}</div>
                ${rexCommentary}
                <div class="detail-section"><h3>ğŸ’¡ AIæŠ•æ¨™åƒ¹æ ¼å»ºè­°</h3><div class="price-grid"><div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆç­–ç•¥</h4><div class="price">${result.bidPrices.conservative}</div></div><div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡ç­–ç•¥</h4><div class="price">${result.bidPrices.balanced}</div></div><div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µç­–ç•¥</h4><div class="price">${result.bidPrices.aggressive}</div></div></div></div>
                <div style="text-align:center; margin-top:30px;"><button onclick="location.reload()" style="padding:15px 40px; background:#667eea; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">ğŸ”„ é‡æ–°è©•ä¼°</button></div>
            `;
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                cbName: document.getElementById('cbName').value,
                industry: document.getElementById('industry').value,
                issueSize: parseFloat(document.getElementById('issueSize').value),
                years: parseInt(document.getElementById('years').value),
                guarantee: document.getElementById('guarantee').value,
                rating: document.getElementById('rating').value,
                capital: parseFloat(document.getElementById('capital').value),
                stockPrice: parseFloat(document.getElementById('stockPrice').value),
                conversionPrice: parseFloat(document.getElementById('conversionPrice').value)
            };
            displayResult(calculateEvaluation(formData));
        });

        window.addEventListener('DOMContentLoaded', loadStatistics);
    </script>
</body>
</html>
