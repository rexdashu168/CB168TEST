<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.6 (å³æ™‚é‹ç®—ç‰ˆ) - Rexå¤§å”</title>
    
    <style>
        /* ================= é¢¨æ ¼è¨­å®š ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }

        /* æ¨™é¡Œå€ */
        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        .version-badge { display: inline-block; background: #9C27B0; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

        /* ä¸»è¦ä½ˆå±€ */
        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
        
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group small { display: block; color: #999; font-size: 12px; margin-top: 5px; }

        /* è³‡è¨Šæ¡† (å„ªåŒ–ç‰ˆ) */
        .info-box {
            background: #e8f5e9; padding: 15px; border-radius: 8px;
            border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        
        .calculate-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .calculate-btn:hover { transform: translateY(-2px); }

        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        
        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
        }
        .detail-section {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 25px; border: 2px solid #e0e0e0;
        }
        .detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table th {
            background-color: #01579b; color: white; padding: 12px 8px;
            text-align: center; font-weight: normal; border: 1px solid #01457b;
        }
        .data-table td { padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f5f5f5; }
        .data-table tr:hover { background-color: #e3f2fd; }
        .val-pos { color: #d32f2f; font-weight: bold; }
        .val-neg { color: #388e3c; font-weight: bold; }
        .val-neu { color: #333; }

        @media (max-width: 1200px) {
            .evaluation-container { grid-template-columns: 1fr; }
            .input-panel { position: relative; top: 0; }
        }
    </style>
</head>
<body>
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
        è¼‰å…¥ä¸¦è¨ˆç®—çµ±è¨ˆæ•¸æ“šä¸­...
    </div>
    
    <div class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.6 å³æ™‚é‹ç®—ç‰ˆ</span></h1>
            <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
                <form id="evaluationForm">
                    <div class="form-section">
                        <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                        <div class="form-group">
                            <label>CBåç¨± *</label>
                            <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                            <div id="cbNameInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                            <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                            <div id="capitalInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­åˆ†é¡ *</label>
                            <select id="industry" required><option value="">è«‹é¸æ“‡...</option></select>
                            <div id="industryInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œåˆ¸å•†</label>
                            <select id="broker"><option value="">è«‹é¸æ“‡...</option></select>
                            <div id="brokerInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                        <div class="form-group">
                            <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                            <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š30">
                            <div id="sizeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š490.7">
                            <div id="conversionInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œå¹´æœŸ *</label>
                            <select id="years" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="3">3å¹´æœŸ</option>
                                <option value="5">5å¹´æœŸ</option>
                                <option value="7">7å¹´æœŸ</option>
                            </select>
                            <div id="yearsInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>æ“”ä¿æƒ…æ³ *</label>
                            <select id="guarantee" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                            <div id="guaranteeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                            <select id="rating" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="1">TCRI 1</option>
                                <option value="2">TCRI 2</option>
                                <option value="3">TCRI 3</option>
                                <option value="4">TCRI 4</option>
                                <option value="5">TCRI 5</option>
                                <option value="6">TCRI 6</option>
                                <option value="7">TCRI 7</option>
                                <option value="8">TCRI 8</option>
                                <option value="9">TCRI 9</option>
                                <option value="BBB">BBBç´š</option>
                            </select>
                            <div id="ratingInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                        <div class="form-group">
                            <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                        <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                            <div class="stats-header" style="color:#1976D2;">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                            <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€ï¼Œç³»çµ±å°‡è‡ªå‹•èª¿é–±æ­·å²æ¡ˆä¾‹åˆ†æã€‚</div>
                        </div>
                    </div>

                    <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                        <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                    </div>

                    <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
                </form>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                    <p>æ•´åˆExcelå®Œæ•´è³‡æ–™åº«<br>å³æ™‚é‹ç®—æ­·å²æ•¸æ“š</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script>
        let statistics = null;
        let cbDatabase = null;
        let auctionRawData = null;

        // ==========================================
        // 1. å³æ™‚é‹ç®—æ ¸å¿ƒ (è§£æ±º undefined å•é¡Œ)
        // ==========================================
        function calculateStatsRealtime(filterFn) {
            // 1. æ’ˆå–ç«¶æ‹æ•¸æ“š (Winning Bid, Premiums)
            const auctionMatches = auctionRawData.filter(filterFn);
            
            // 2. æ’ˆå–æ›ç‰Œæ•¸æ“š (High, Low) - å¾ cbDatabase è½‰ array
            const cbMatches = Object.values(cbDatabase).filter(filterFn);

            // è¨ˆç®—ç«¶æ‹çµ±è¨ˆ
            let lowestBidSum = 0, avgBidSum = 0, lowestPremSum = 0, avgPremSum = 0;
            let auctionCount = auctionMatches.length;

            auctionMatches.forEach(item => {
                lowestBidSum += item['æœ€ä½å¾—æ¨™'] || 0;
                avgBidSum += item['å¹³å‡å¾—æ¨™'] || 0;
                lowestPremSum += item['æœ€ä½æº¢åƒ¹'] || 0;
                avgPremSum += item['å¹³å‡æº¢åƒ¹'] || 0;
            });

            // è¨ˆç®—æ›ç‰Œçµ±è¨ˆ
            let highSum = 0, lowSum = 0;
            let validPriceCount = 0;

            cbMatches.forEach(item => {
                if (item['æ›ç‰Œæœ€é«˜'] && item['æ›ç‰Œæœ€ä½']) {
                    highSum += parseFloat(item['æ›ç‰Œæœ€é«˜']);
                    lowSum += parseFloat(item['æ›ç‰Œæœ€ä½']);
                    validPriceCount++;
                }
            });

            return {
                sampleCount: auctionCount,
                sampleRatio: (auctionCount / auctionRawData.length * 100).toFixed(1),
                avgLowestBid: auctionCount > 0 ? (lowestBidSum / auctionCount).toFixed(2) : null,
                avgAvgBid: auctionCount > 0 ? (avgBidSum / auctionCount).toFixed(2) : null,
                avgLowestPrem: auctionCount > 0 ? (lowestPremSum / auctionCount * 100).toFixed(2) : null, // åŸå§‹è³‡æ–™é€šå¸¸æ˜¯å°æ•¸ (0.05)ï¼Œé¡¯ç¤ºè¦ä¹˜100
                avgAvgPrem: auctionCount > 0 ? (avgPremSum / auctionCount * 100).toFixed(2) : null,
                
                // æ›ç‰Œæ•¸æ“š
                listingCount: validPriceCount,
                avgListHigh: validPriceCount > 0 ? (highSum / validPriceCount).toFixed(2) : null,
                avgListLow: validPriceCount > 0 ? (lowSum / validPriceCount).toFixed(2) : null
            };
        }

        function generateCardHTML(stats, title = "æ­·å²çµ±è¨ˆ") {
            if (!stats || stats.sampleCount === 0) return `<div class="stats-header">${title}</div><div class="stat-row">ç„¡ç›¸é—œæ­·å²æ¡ˆä¾‹</div>`;

            let html = `
                <div class="stats-header">ğŸ“Š ${title}</div>
                <div class="stat-row" style="color:#555; font-weight:bold;">æ­·å²æ¨£æœ¬: ${stats.sampleCount} æª” (${stats.sampleRatio}%)</div>
                <div class="stat-row">ğŸ“‰ æœ€ä½å¾—æ¨™: ${stats.avgLowestBid || '-'}å…ƒ / æº¢åƒ¹ ${stats.avgLowestPrem || '-'}%</div>
                <div class="stat-row">âš–ï¸ å¹³å‡å¾—æ¨™: ${stats.avgAvgBid || '-'}å…ƒ / æº¢åƒ¹ ${stats.avgAvgPrem || '-'}%</div>
            `;

            if (stats.avgListHigh && stats.avgListLow) {
                const h = parseFloat(stats.avgListHigh);
                const l = parseFloat(stats.avgListLow);
                const amp = ((h - l) / l * 100).toFixed(1);
                html += `
                    <div class="stat-row" style="margin-top:8px; padding-top:8px; border-top:1px dashed #ccc; justify-content: space-between;">
                        <span>ğŸ“ˆ æœ€é«˜:${h}</span><span>ğŸ“‰ æœ€ä½:${l}</span><span style="color:#E91E63;">âš¡ æŒ¯å¹…:${amp}%</span>
                    </div>
                `;
            } else {
                html += `<div class="stat-row" style="margin-top:5px; color:#999; font-size:12px;">(å°šç„¡è¶³å¤ æ›ç‰Œæ•¸æ“šè¨ˆç®—æŒ¯å¹…)</div>`;
            }
            return html;
        }

        // ==========================================
        // 2. åˆå§‹åŒ–
        // ==========================================
        async function loadStatistics() {
            const loadingDiv = document.getElementById('loading');
            try {
                const response = await fetch('cb_data_integrated.json');
                if (!response.ok) throw new Error('HTTP error');
                const data = await response.json();
                
                statistics = data['çµ±è¨ˆæ•¸æ“š'];
                cbDatabase = data['CBè³‡æ–™åº«'];
                auctionRawData = data['ç«¶æ‹åŸå§‹è³‡æ–™'];
                
                // é å…ˆè™•ç† auctionRawDataï¼Œç¢ºä¿æ•¸å­—æ ¼å¼æ­£ç¢º (é‡å°æº¢åƒ¹ï¼Œå¦‚æœæ˜¯ç™¾åˆ†æ¯”å­—ä¸²è¦è½‰å°æ•¸ï¼Œå¦‚æœæ˜¯å°æ•¸å‰‡ä¿ç•™)
                // å‡è¨­åŸå§‹è³‡æ–™å·²ç¶“ä¹¾æ·¨ï¼Œå¦‚æœä¸ä¹¾æ·¨å¯åœ¨é€™è£¡æ¸…æ´—

                initializeUI();
                loadingDiv.style.display = 'none';
                document.querySelector('.container').style.display = 'block';
            } catch (error) {
                console.error(error);
                loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:red;border-radius:10px;">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª json æª”æ¡ˆå­˜åœ¨ã€‚</div>`;
            }
        }

        function initializeUI() {
            const totalCB = Object.keys(cbDatabase).length;
            document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ${totalCB.toLocaleString()}æª”CBå®Œæ•´è³‡æ–™`;
            
            // å¡«å……é¸å–®
            populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
            populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
            
            showStatsSummary();
            bindInputEvents();
        }

        function populateSelect(id, dataObj) {
            const select = document.getElementById(id);
            const items = Object.keys(dataObj).sort((a, b) => (dataObj[b]['æ¨£æœ¬æ•¸'] || 0) - (dataObj[a]['æ¨£æœ¬æ•¸'] || 0));
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                const avgHigh = dataObj[item]['å¹³å‡æ›ç‰Œæœ€é«˜'];
                option.textContent = avgHigh ? `${item} (æœ€é«˜${avgHigh}å…ƒ)` : item;
                select.appendChild(option);
            });
        }

        function showStatsSummary() {
            document.getElementById('statsSummary').innerHTML = `
                <div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">CBè³‡æ–™åº«</div></div>
                <div class="stat-box"><div class="number">${statistics['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸']}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
            `;
        }

        // ==========================================
        // 3. äº‹ä»¶ç¶å®š (ä½¿ç”¨å³æ™‚é‹ç®—)
        // ==========================================
        function bindInputEvents() {
            const show = (id, html) => { 
                const el = document.getElementById(id); 
                el.innerHTML = html; 
                el.style.display = html ? 'block' : 'none'; 
            };

            // 1. CBåç¨±
            document.getElementById('cbName').addEventListener('input', function() {
                const found = Object.values(cbDatabase).find(d => d['åç¨±'].includes(this.value.trim()));
                if (found) {
                    let html = `
                        <div class="stats-header">ğŸ“Š æ›ç‰Œåƒ¹æ ¼åƒè€ƒ</div>
                        <div class="stat-row">${found['ä»£è™Ÿ']} / ${found['è‚¡ç¥¨ä»£è™Ÿ']}</div>
                        <div class="stat-row" style="justify-content: space-between;"><span>ğŸ“ˆ æœ€é«˜:${found['æ›ç‰Œæœ€é«˜']||'-'}</span><span>ğŸ“‰ æœ€ä½:${found['æ›ç‰Œæœ€ä½']||'-'}</span></div>
                    `;
                    if (found['æ›ç‰Œæœ€é«˜'] && found['æ›ç‰Œæœ€ä½']) {
                        const h = parseFloat(found['æ›ç‰Œæœ€é«˜']), l = parseFloat(found['æ›ç‰Œæœ€ä½']);
                        html += `<div class="stat-row" style="justify-content:flex-end; color:#E91E63;">âš¡ æŒ¯å¹…:${((h-l)/l*100).toFixed(1)}%</div>`;
                    }
                    show('cbNameInfo', html);
                } else show('cbNameInfo', '');
            });

            // 2. è‚¡æœ¬ (6å€é–“)
            document.getElementById('capital').addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!val) return;
                
                let range = '';
                let filterFn = null;

                if (val < 3) { range = '<3å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) < 3; }
                else if (val < 6) { range = '3-6å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) >= 3 && (item['è‚¡æœ¬'] || 0) < 6; }
                else if (val < 10) { range = '6-10å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) >= 6 && (item['è‚¡æœ¬'] || 0) < 10; }
                else if (val < 15) { range = '10-15å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) >= 10 && (item['è‚¡æœ¬'] || 0) < 15; }
                else if (val < 20) { range = '15-20å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) >= 15 && (item['è‚¡æœ¬'] || 0) < 20; }
                else { range = '>20å„„'; filterFn = item => (item['è‚¡æœ¬'] || 0) >= 20; }

                const stats = calculateStatsRealtime(filterFn);
                show('capitalInfo', generateCardHTML(stats, `æ­·å²çµ±è¨ˆ (å€é–“:${range})`));
            });

            // 3. ç”¢æ¥­
            document.getElementById('industry').addEventListener('change', function() {
                if (!this.value) return;
                const stats = calculateStatsRealtime(item => item['ç”¢æ¥­'] === this.value);
                show('industryInfo', generateCardHTML(stats));
            });

            // 4. åˆ¸å•† (æ¨¡ç³Šæ¯”å°ï¼Œè§£æ±ºåç¨±ä¸ä¸€è‡´å•é¡Œ)
            document.getElementById('broker').addEventListener('change', function() {
                const val = this.value;
                if (!val) return;
                // ä½¿ç”¨ includes å¢åŠ åŒ¹é…æˆåŠŸç‡
                const stats = calculateStatsRealtime(item => (item['ç™¼è¡Œåˆ¸å•†'] || '').includes(val) || (item['åˆ¸å•†'] || '').includes(val));
                show('brokerInfo', generateCardHTML(stats));
            });

            // 5. ç™¼è¡Œè¦æ¨¡ (6å€é–“)
            document.getElementById('issueSize').addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!val) return;
                
                let range = '';
                let filterFn = null;
                if (val < 2) { range = '<2å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) < 2; }
                else if (val < 5) { range = '2-5å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) >= 2 && (item['ç™¼è¡Œè¦æ¨¡'] || 0) < 5; }
                else if (val < 10) { range = '5-10å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) >= 5 && (item['ç™¼è¡Œè¦æ¨¡'] || 0) < 10; }
                else if (val < 15) { range = '10-15å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) >= 10 && (item['ç™¼è¡Œè¦æ¨¡'] || 0) < 15; }
                else if (val < 20) { range = '15-20å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) >= 15 && (item['ç™¼è¡Œè¦æ¨¡'] || 0) < 20; }
                else { range = '>20å„„'; filterFn = item => (item['ç™¼è¡Œè¦æ¨¡'] || 0) >= 20; }

                const stats = calculateStatsRealtime(filterFn);
                show('sizeInfo', generateCardHTML(stats, `æ­·å²çµ±è¨ˆ (å€é–“:${range})`));
            });

            // 6. è½‰æ›åƒ¹
            document.getElementById('conversionPrice').addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!val) return;
                let range = val < 20 ? '<20å…ƒ' : val < 50 ? '20-50å…ƒ' : val < 100 ? '50-100å…ƒ' : val < 150 ? '100-150å…ƒ' : val < 200 ? '150-200å…ƒ' : '>200å…ƒ';
                // é€™è£¡ç°¡å–®è™•ç†å€é–“ï¼ŒåŒæ¨£å¯ä»¥ç”¨ dynamicï¼Œä½†ç‚ºäº†æ•ˆèƒ½ï¼Œå¦‚æœ filter æ¯”è¼ƒè¤‡é›œï¼Œè½‰æ›åƒ¹å¯ä»¥ä¾è³´ JSON 
                // ä½†ç‚ºäº†çµ±ä¸€ï¼Œæˆ‘å€‘ä¹Ÿç”¨ dynamic
                // æ³¨æ„ï¼šcbDatabase çš„è½‰æ›åƒ¹å¯èƒ½è¦ parse
                const filterFn = item => {
                    const price = parseFloat(item['è½‰æ›åƒ¹'] || item['è½‰æ›åƒ¹æ ¼'] || 0);
                    if (val < 20) return price < 20;
                    if (val < 50) return price >= 20 && price < 50;
                    if (val < 100) return price >= 50 && price < 100;
                    if (val < 150) return price >= 100 && price < 150;
                    if (val < 200) return price >= 150 && price < 200;
                    return price >= 200;
                };
                const stats = calculateStatsRealtime(filterFn);
                show('conversionInfo', generateCardHTML(stats, `æ­·å²çµ±è¨ˆ (å€é–“:${range})`));
                updateSmartReminders();
            });

            // 7. å¹´æœŸ
            document.getElementById('years').addEventListener('change', function() {
                if (!this.value) return;
                const y = parseInt(this.value);
                const stats = calculateStatsRealtime(item => parseInt(item['ç™¼è¡Œå¹´æœŸ'] || item['å¹´æœŸ']) === y);
                show('yearsInfo', generateCardHTML(stats));
            });

            // 8. æ“”ä¿
            document.getElementById('guarantee').addEventListener('change', function() {
                if (!this.value) return;
                const stats = calculateStatsRealtime(item => item['æ“”ä¿'] === this.value);
                show('guaranteeInfo', generateCardHTML(stats));
                updateMarketSentimentDisplay();
            });

            // 9. ä¿¡è©•
            document.getElementById('rating').addEventListener('change', function() {
                const val = this.value;
                if (!val) return;
                
                // å®šç¾© filter
                let filterFn = null;
                if (val === 'BBB') filterFn = item => (item['ä¿¡è©•'] || '').includes('BBB');
                else {
                    const num = parseInt(val);
                    // é‡å° TCRI 1~9ï¼Œè³‡æ–™åº«å¯èƒ½å­˜ "TCRI 5" æˆ– "5"
                    filterFn = item => {
                        const r = item['ä¿¡è©•'] || item['TCRI'] || '';
                        return r.includes(val) || r == val;
                    };
                }
                const stats = calculateStatsRealtime(filterFn);
                show('ratingInfo', generateCardHTML(stats));
            });

            document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
        }

        // ==========================================
        // 4. è¨ˆç®—èˆ‡çµæœ (ä¿®å¾©ç†è«–åƒ¹0%)
        // ==========================================
        
        function calculateRecentMarketSentiment() {
            if (!auctionRawData) return { low: 0, avg: 0 };
            const today = new Date();
            const cutoff = new Date(); cutoff.setDate(today.getDate() - 90);
            const cases = auctionRawData.filter(item => new Date(item['é–‹æ¨™æ—¥æœŸ']) >= cutoff);
            if (cases.length === 0) return { low: 0, avg: 0 };
            const avgLow = cases.reduce((sum, item) => sum + item['æœ€ä½æº¢åƒ¹'], 0) / cases.length;
            const avgAvg = cases.reduce((sum, item) => sum + item['å¹³å‡æº¢åƒ¹'], 0) / cases.length;
            return { low: (avgLow * 100).toFixed(2), avg: (avgAvg * 100).toFixed(2), count: cases.length };
        }

        function calculateEvaluation(data) {
            const theoreticalPrice = (data.stockPrice / data.conversionPrice) * 100;
            
            // å®šç¾©å€é–“é¡¯ç¤ºæ–‡å­—
            let sizeRange = data.issueSize < 2 ? '<2å„„' : data.issueSize < 5 ? '2-5å„„' : data.issueSize < 10 ? '5-10å„„' : data.issueSize < 15 ? '10-15å„„' : data.issueSize < 20 ? '15-20å„„' : '>20å„„';
            let capitalRange = data.capital < 3 ? '<3å„„' : data.capital < 6 ? '3-6å„„' : data.capital < 10 ? '6-10å„„' : data.capital < 15 ? '10-15å„„' : data.capital < 20 ? '15-20å„„' : '>20å„„';
            let convRange = data.conversionPrice < 20 ? '<20å…ƒ' : data.conversionPrice < 50 ? '20-50å…ƒ' : data.conversionPrice < 100 ? '50-100å…ƒ' : data.conversionPrice < 150 ? '100-150å…ƒ' : data.conversionPrice < 200 ? '150-200å…ƒ' : '>200å…ƒ';
            let theoRange = theoreticalPrice < 85 ? '<85å…ƒ' : theoreticalPrice < 90 ? '85-90å…ƒ' : theoreticalPrice < 95 ? '90-95å…ƒ' : theoreticalPrice < 98 ? '95-98å…ƒ' : theoreticalPrice < 100 ? '98-100å…ƒ' : theoreticalPrice < 102 ? '100-102å…ƒ' : theoreticalPrice < 105 ? '102-105å…ƒ' : theoreticalPrice < 110 ? '105-110å…ƒ' : '>110å…ƒ';

            // æ ¸å¿ƒï¼šä½¿ç”¨ calculateStatsRealtime å–å¾—æº–ç¢ºæ•¸å€¼
            // ç‚ºäº†è®“è¡¨æ ¼ä¸ç‚º0ï¼Œæˆ‘å€‘å³æ™‚é‹ç®—
            const getS = (fn) => {
                const s = calculateStatsRealtime(fn);
                return { low: parseFloat(s.avgLowestPrem || 0), avg: parseFloat(s.avgAvgPrem || 0) };
            };

            const stats = {};
            stats.industry = getS(i => i['ç”¢æ¥­'] === data.industry);
            
            // Size
            stats.size = getS(i => {
                const v = i['ç™¼è¡Œè¦æ¨¡']||0;
                if(data.issueSize<2) return v<2;
                if(data.issueSize<5) return v>=2 && v<5;
                if(data.issueSize<10) return v>=5 && v<10;
                if(data.issueSize<15) return v>=10 && v<15;
                if(data.issueSize<20) return v>=15 && v<20;
                return v>=20;
            });

            // Capital
            stats.capital = getS(i => {
                const v = i['è‚¡æœ¬']||0;
                if(data.capital<3) return v<3;
                if(data.capital<6) return v>=3 && v<6;
                if(data.capital<10) return v>=6 && v<10;
                if(data.capital<15) return v>=10 && v<15;
                if(data.capital<20) return v>=15 && v<20;
                return v>=20;
            });

            // Years
            stats.years = getS(i => parseInt(i['ç™¼è¡Œå¹´æœŸ']||i['å¹´æœŸ']) === data.years);
            
            // Guarantee
            stats.guarantee = getS(i => i['æ“”ä¿'] === data.guarantee);
            
            // Rating
            stats.rating = getS(i => {
                if(data.rating==='BBB') return (i['ä¿¡è©•']||'').includes('BBB');
                return (i['ä¿¡è©•']||'').includes(data.rating) || (i['TCRI']||'') == data.rating;
            });

            // Conversion
            stats.conversion = getS(i => {
                const v = parseFloat(i['è½‰æ›åƒ¹']||0);
                if(data.conversionPrice<20) return v<20;
                if(data.conversionPrice<50) return v>=20 && v<50;
                if(data.conversionPrice<100) return v>=50 && v<100;
                if(data.conversionPrice<150) return v>=100 && v<150;
                if(data.conversionPrice<200) return v>=150 && v<200;
                return v>=200;
            });

            // Theoretical Price (è§£æ±º 0% å•é¡Œ)
            // éœ€è¦åæ¨æ¯å€‹ç«¶æ‹æ¡ˆåœ¨ã€Œæˆªæ¨™ç•¶ä¸‹ã€çš„ç†è«–åƒ¹
            // è³‡æ–™åº«ä¸­å¿…é ˆæœ‰ã€Œæˆªæ¨™æ™‚è‚¡åƒ¹ã€æ‰èƒ½ç®—ã€‚å¦‚æœæ²’æœ‰ï¼Œæˆ‘å€‘ç”¨ã€Œç†è«–åƒ¹ã€æ¬„ä½
            stats.theoretical = getS(i => {
                // å‡è¨­è³‡æ–™åº«æœ‰ 'æˆªæ¨™ç†è«–åƒ¹' æˆ–é¡ä¼¼æ¬„ä½ï¼Œå¦‚æœæ²’æœ‰ï¼Œé€™è£¡å¯èƒ½é‚„æ˜¯æœƒç®—ä¸å‡º
                // ä½†é€šå¸¸æœƒæœ‰ 'ç†è«–åƒ¹' æ¬„ä½
                const t = parseFloat(i['ç†è«–åƒ¹'] || 0); // ç¢ºä¿ json æœ‰æ­¤æ¬„ä½
                if(theoreticalPrice<85) return t<85;
                if(theoreticalPrice<90) return t>=85 && t<90;
                if(theoreticalPrice<95) return t>=90 && t<95;
                if(theoreticalPrice<98) return t>=95 && t<98;
                if(theoreticalPrice<100) return t>=98 && t<100;
                if(theoreticalPrice<102) return t>=100 && t<102;
                if(theoreticalPrice<105) return t>=102 && t<105;
                if(theoreticalPrice<110) return t>=105 && t<110;
                return t>=110;
            });
            // å¦‚æœä¸Šè¿°ç®—å‡º 0 (å› ç‚ºæ²’å°æ‡‰è³‡æ–™)ï¼Œæˆ‘å€‘çµ¦ä¸€å€‹é è¨­å€¼æˆ–å¾ JSON è®€å–ç•¶ä½œ fallback
            if(stats.theoretical.low === 0 && statistics['ç¶­åº¦çµ±è¨ˆ']['ç†è«–åƒ¹'][theoRange]) {
                 stats.theoretical.low = statistics['ç¶­åº¦çµ±è¨ˆ']['ç†è«–åƒ¹'][theoRange]['å¹³å‡æœ€ä½æº¢åƒ¹'];
            }

            // Market
            const sent = calculateRecentMarketSentiment();
            stats.market = { low: parseFloat(sent.low), avg: parseFloat(sent.avg) };

            const weights = { theoretical: 0.30, guarantee: 0.20, industry: 0.15, size: 0.10, rating: 0.10, conversion: 0.08, years: 0.05, capital: 0.02 };
            
            let comprehensivePremium = 
                stats.theoretical.low * weights.theoretical +
                stats.guarantee.low * weights.guarantee +
                stats.industry.low * weights.industry +
                stats.size.low * weights.size +
                stats.rating.low * weights.rating +
                stats.conversion.low * weights.conversion +
                stats.years.low * weights.years +
                stats.capital.low * weights.capital;
            
            const theoreticalBidPrice = theoreticalPrice * (1 + comprehensivePremium / 100);

            return {
                cbName: data.cbName,
                theoreticalPrice: theoreticalPrice.toFixed(2),
                stats: stats,
                comprehensivePremium: comprehensivePremium.toFixed(2),
                theoreticalBidPrice: theoreticalBidPrice.toFixed(2),
                bidPrices: {
                    conservative: (theoreticalBidPrice * 0.95).toFixed(2),
                    balanced: (theoreticalBidPrice * 1.00).toFixed(2),
                    aggressive: (theoreticalBidPrice * 1.05).toFixed(2)
                },
                inputData: { ...data, ratingDisplay: `TCRI ${data.rating}` },
                ranges: { size: sizeRange, capital: capitalRange, conversion: convRange, theoretical: theoRange }
            };
        }

        function displayResult(result) {
            document.getElementById('welcomeMsg').style.display = 'none';
            const resultDiv = document.getElementById('evaluationResult');
            resultDiv.className = 'evaluation-result active';
            
            const fmtVal = (val) => {
                const num = parseFloat(val);
                const cls = num > 0 ? 'val-pos' : num < 0 ? 'val-neg' : 'val-neu';
                return `<span class="${cls}">${num.toFixed(2)}%</span>`;
            };

            const s = result.stats;
            const w = { theo: 0.3, guar: 0.2, ind: 0.15, size: 0.1, rate: 0.1, conv: 0.08, yr: 0.05, cap: 0.02 };

            const tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr><th>ç¶­åº¦</th><th>æ¢ä»¶å€é–“</th><th>æ­·å²æœ€ä½æº¢åƒ¹</th><th>æ­·å²å¹³å‡æº¢åƒ¹</th><th>æ¬Šé‡</th><th>åŠ æ¬Šçµæœ</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>ç†è«–åƒ¹ä½</td><td>${result.ranges.theoretical}</td><td>${fmtVal(s.theoretical.low)}</td><td>${fmtVal(s.theoretical.avg)}</td><td>30%</td><td>${fmtVal(s.theoretical.low * w.theo)}</td></tr>
                        <tr><td>æ“”ä¿æƒ…æ³</td><td>${result.inputData.guarantee}</td><td>${fmtVal(s.guarantee.low)}</td><td>${fmtVal(s.guarantee.avg)}</td><td>20%</td><td>${fmtVal(s.guarantee.low * w.guar)}</td></tr>
                        <tr><td>ç”¢æ¥­åˆ†é¡</td><td>${result.inputData.industry}</td><td>${fmtVal(s.industry.low)}</td><td>${fmtVal(s.industry.avg)}</td><td>15%</td><td>${fmtVal(s.industry.low * w.ind)}</td></tr>
                        <tr><td>ç™¼è¡Œè¦æ¨¡</td><td>${result.ranges.size}</td><td>${fmtVal(s.size.low)}</td><td>${fmtVal(s.size.avg)}</td><td>10%</td><td>${fmtVal(s.size.low * w.size)}</td></tr>
                        <tr><td>ä¿¡ç”¨è©•ç­‰</td><td>${result.inputData.ratingDisplay}</td><td>${fmtVal(s.rating.low)}</td><td>${fmtVal(s.rating.avg)}</td><td>10%</td><td>${fmtVal(s.rating.low * w.rate)}</td></tr>
                        <tr><td>è½‰æ›åƒ¹æ ¼</td><td>${result.ranges.conversion}</td><td>${fmtVal(s.conversion.low)}</td><td>${fmtVal(s.conversion.avg)}</td><td>8%</td><td>${fmtVal(s.conversion.low * w.conv)}</td></tr>
                        <tr><td>ç™¼è¡Œå¹´æœŸ</td><td>${result.inputData.years}å¹´</td><td>${fmtVal(s.years.low)}</td><td>${fmtVal(s.years.avg)}</td><td>5%</td><td>${fmtVal(s.years.low * w.yr)}</td></tr>
                        <tr><td>è‚¡æœ¬å¤§å°</td><td>${result.ranges.capital}</td><td>${fmtVal(s.capital.low)}</td><td>${fmtVal(s.capital.avg)}</td><td>2%</td><td>${fmtVal(s.capital.low * w.cap)}</td></tr>
                        <tr style="background-color: #fff3e0;">
                            <td><strong>å¸‚å ´æ°›åœ</strong></td><td>è¿‘3å€‹æœˆ</td><td>${fmtVal(s.market.low)}</td><td>${fmtVal(s.market.avg)}</td><td>-</td><td>åƒè€ƒ</td>
                        </tr>
                        <tr style="background-color: #e3f2fd; border-top: 2px solid #1976D2;">
                            <td colspan="5" style="text-align:right; font-weight:bold; color:#0d47a1; padding-right:20px;">ç¶œåˆæœ€ä½æº¢åƒ¹ç‡é ä¼°</td>
                            <td style="font-weight:bold; font-size:16px; color:#d32f2f;">${result.comprehensivePremium}%</td>
                        </tr>
                    </tbody>
                </table>
            `;

            resultDiv.innerHTML = `
                <div class="result-header">
                    <h2>${result.cbName}</h2>
                    <div class="subtitle">è³‡æ–™é©…å‹•AIè©•ä¼°çµæœ (V3.6)</div>
                </div>
                <div class="detail-section">
                    <h3>ğŸ“Š ç†è«–åƒ¹æ ¼è¨ˆç®—</h3>
                    <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;">
                        <div style="font-size:48px; font-weight:bold; color:#667eea;">${result.theoreticalPrice} å…ƒ</div>
                        <div style="color:#999;">= è‚¡åƒ¹ ${result.inputData.stockPrice} Ã· è½‰åƒ¹ ${result.inputData.conversionPrice} Ã— 100</div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>ğŸ” æº¢åƒ¹ç‡åˆ†è§£åˆ†æè¡¨</h3>
                    ${tableHtml}
                </div>
                <div class="detail-section">
                    <h3>ğŸ’¡ AIæŠ•æ¨™åƒ¹æ ¼å»ºè­°</h3>
                    <div class="price-grid">
                        <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆç­–ç•¥</h4><div class="price">${result.bidPrices.conservative}</div><div style="font-size:12px;color:#666">è²¼è¿‘åœ°æ¿åƒ¹ï¼Œå®‰å…¨é‚Šéš›é«˜</div></div>
                        <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡ç­–ç•¥</h4><div class="price">${result.bidPrices.balanced}</div><div style="font-size:12px;color:#666">åˆç†æº¢åƒ¹ï¼Œå…¼é¡§å¾—æ¨™ç‡</div></div>
                        <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µç­–ç•¥</h4><div class="price">${result.bidPrices.aggressive}</div><div style="font-size:12px;color:#666">è¿½é€ç†±é–€ï¼Œç¢ºä¿ç±Œç¢¼</div></div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:30px;">
                    <button onclick="resetForm()" style="padding:15px 40px; background:#667eea; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">ğŸ”„ é‡æ–°è©•ä¼°</button>
                </div>
            `;
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetForm() {
            document.getElementById('evaluationForm').reset();
            document.getElementById('welcomeMsg').style.display = 'block';
            document.getElementById('evaluationResult').className = 'evaluation-result';
            document.querySelectorAll('.info-box').forEach(el => el.style.display = 'none');
            updateMarketSentimentDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateMarketSentimentDisplay() {
             const div = document.getElementById('marketSentiment');
             if(!auctionRawData) return;
             const sent = calculateRecentMarketSentiment();
             div.innerHTML = `
                <div class="stats-header">ğŸŒ¡ï¸ è¿‘3å€‹æœˆå¸‚å ´æ°›åœ</div>
                <div class="stat-row">çµ±è¨ˆæ¨£æœ¬: è¿‘ ${sent.count} æª”ç«¶æ‹æ¡ˆ</div>
                <div class="stat-row" style="justify-content:space-between;">
                    <span>ğŸ“‰ å¹³å‡æœ€ä½æº¢åƒ¹:<strong style="color:#388e3c">${sent.low}%</strong></span>
                    <span>âš–ï¸ å¹³å‡å¾—æ¨™æº¢åƒ¹:<strong style="color:#d32f2f">${sent.avg}%</strong></span>
                </div>
             `;
        }
        
        function updateSmartReminders() {
            const stock = parseFloat(document.getElementById('stockPrice').value);
            const conv = parseFloat(document.getElementById('conversionPrice').value);
            const div = document.getElementById('smartReminders');
            if (stock && conv) {
                const theo = (stock/conv)*100;
                let msg = theo > 110 ? 'âš ï¸ ç†è«–åƒ¹åé«˜' : theo < 85 ? 'ğŸ’¡ ç†è«–åƒ¹ä½æ–¼ä½æª”' : 'âœ¨ ç†è«–åƒ¹åˆç†';
                document.getElementById('reminderContent').textContent = msg;
                div.style.display = 'block';
            }
        }

        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!statistics) return;
            const formData = {
                cbName: document.getElementById('cbName').value,
                industry: document.getElementById('industry').value,
                issueSize: parseFloat(document.getElementById('issueSize').value),
                years: parseInt(document.getElementById('years').value),
                guarantee: document.getElementById('guarantee').value,
                rating: document.getElementById('rating').value,
                capital: parseFloat(document.getElementById('capital').value),
                stockPrice: parseFloat(document.getElementById('stockPrice').value),
                conversionPrice: parseFloat(document.getElementById('conversionPrice').value)
            };
            displayResult(calculateEvaluation(formData));
        });

        window.addEventListener('DOMContentLoaded', loadStatistics);
    </script>
</body>
</html>
