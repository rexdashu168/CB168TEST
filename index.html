<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.12 (å®‰å…¨å•Ÿå‹•ç‰ˆ)</title>
    
    <style>
        /* ================= é¢¨æ ¼è¨­å®š ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; display: none; } /* é è¨­éš±è—ï¼Œç­‰JSè¼‰å…¥ */

        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        
        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; border-bottom: 3px solid #667eea; padding-bottom: 15px; }
        
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

        /* æŒ‰éˆ•å€ */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .calculate-btn {
            flex: 2; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s;
        }
        .calculate-btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .demo-btn {
            flex: 1; padding: 18px; background: #009688; color: white; border: none; border-radius: 10px;
            font-size: 16px; cursor: pointer; font-weight: bold;
        }
        .demo-btn:hover { background: #00796b; }

        /* çµæœé¢æ¿ */
        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }

        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .detail-section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 25px; border: 2px solid #e0e0e0; }
        .detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }

        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        .data-table th { background-color: #01579b; color: white; padding: 12px 8px; text-align: center; border: 1px solid #01457b; }
        .data-table td { padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f5f5f5; }
        .val-pos { color: #d32f2f; font-weight: bold; }
        .val-neg { color: #388e3c; font-weight: bold; }
        .val-neu { color: #333; }
        
        /* Loading é®ç½© */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 1200px) { .evaluation-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span style="background: #FF9800; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">Debugç‰ˆ</span></h1>
            <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
                <div id="evaluationForm">
                    <div class="form-section">
                        <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                        <div class="form-group">
                            <label>CBåç¨±</label>
                            <input type="text" id="cbName" placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                        </div>
                        <div class="form-group">
                            <label>è‚¡æœ¬ (å„„å…ƒ)</label>
                            <input type="number" id="capital" step="0.01" placeholder="ä¾‹å¦‚ï¼š33.80">
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­åˆ†é¡</label>
                            <select id="industry"><option value="">è«‹é¸æ“‡...</option></select>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œåˆ¸å•†</label>
                            <select id="broker"><option value="">è«‹é¸æ“‡...</option></select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                        <div class="form-group">
                            <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ)</label>
                            <input type="number" id="issueSize" step="0.1" placeholder="ä¾‹å¦‚ï¼š30">
                        </div>
                        <div class="form-group">
                            <label>è½‰æ›åƒ¹æ ¼ (å…ƒ)</label>
                            <input type="number" id="conversionPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š490.7">
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œå¹´æœŸ</label>
                            <select id="years">
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="3">3å¹´æœŸ</option>
                                <option value="5">5å¹´æœŸ</option>
                                <option value="7">7å¹´æœŸ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ“”ä¿æƒ…æ³</label>
                            <select id="guarantee">
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¿¡ç”¨è©•ç­‰ (TCRI)</label>
                            <select id="rating">
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="1">TCRI 1</option>
                                <option value="2">TCRI 2</option>
                                <option value="3">TCRI 3</option>
                                <option value="4">TCRI 4</option>
                                <option value="5">TCRI 5</option>
                                <option value="6">TCRI 6</option>
                                <option value="7">TCRI 7</option>
                                <option value="8">TCRI 8</option>
                                <option value="9">TCRI 9</option>
                                <option value="BBB">BBBç´š</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                        <div class="form-group">
                            <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ)</label>
                            <input type="number" id="stockPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š461.5">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="demo-btn" onclick="fillDemoData()">ğŸª„ ä¸€éµå¸¶å…¥ç¯„ä¾‹</button>
                        <button type="button" class="calculate-btn" onclick="handleCalculation()">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
                    </div>
                </div>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                    <p>è‹¥ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»æ“Šå·¦å´ã€Œä¸€éµå¸¶å…¥ç¯„ä¾‹ã€æŒ‰éˆ•æ¸¬è©¦</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // å…§å»ºæ¨¡æ“¬æ•¸æ“šåº« (ä¿è­‰ä¸éœ€è®€å–å¤–éƒ¨æª”æ¡ˆ)
        // ==========================================
        const MOCK_DB = {
            "CBè³‡æ–™åº«": {
                "1": { "åç¨±": "å°å…‰é›»ä¸ƒ", "ä»£è™Ÿ": "23837" },
                "2": { "åç¨±": "ä¸–ç´€é‹¼äºŒ", "ä»£è™Ÿ": "99582" }
            },
            "çµ±è¨ˆæ•¸æ“š": {
                "è³‡æ–™æœŸé–“": { "ç¸½ç­†æ•¸": 286 },
                "ç¶­åº¦çµ±è¨ˆ": {
                    "ç”¢æ¥­": {
                        "åŠå°é«”æ¥­": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.5, "å¹³å‡æº¢åƒ¹": 6.2, "æ¨£æœ¬æ•¸": 50 },
                        "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.8, "å¹³å‡æº¢åƒ¹": 5.1, "æ¨£æœ¬æ•¸": 45 },
                        "ç”ŸæŠ€é†«ç™‚æ¥­": { "å¹³å‡æœ€ä½æº¢åƒ¹": 2.5, "å¹³å‡æº¢åƒ¹": 4.0, "æ¨£æœ¬æ•¸": 30 },
                        "é›»å­é›¶çµ„ä»¶æ¥­": { "å¹³å‡æœ€ä½æº¢åƒ¹": 5.0, "å¹³å‡æº¢åƒ¹": 6.5, "æ¨£æœ¬æ•¸": 60 }
                    },
                    "ç™¼è¡Œåˆ¸å•†": {
                        "å‡±åŸºè­‰åˆ¸": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.2, "å¹³å‡æº¢åƒ¹": 5.8, "æ¨£æœ¬æ•¸": 40 },
                        "ç¦é‚¦è­‰åˆ¸": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.5, "å¹³å‡æº¢åƒ¹": 4.9, "æ¨£æœ¬æ•¸": 35 },
                        "å…ƒå¤§è­‰åˆ¸": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.0, "å¹³å‡æº¢åƒ¹": 5.5, "æ¨£æœ¬æ•¸": 55 }
                    },
                    "æ“”ä¿": {
                        "æœ‰æ“”ä¿": { "å¹³å‡æœ€ä½æº¢åƒ¹": 2.8, "å¹³å‡æº¢åƒ¹": 4.2, "æ¨£æœ¬æ•¸": 150 },
                        "ç„¡æ“”ä¿": { "å¹³å‡æœ€ä½æº¢åƒ¹": 6.5, "å¹³å‡æº¢åƒ¹": 8.5, "æ¨£æœ¬æ•¸": 136 }
                    },
                    "å¹´æœŸ": {
                        "3å¹´æœŸ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.5, "å¹³å‡æº¢åƒ¹": 4.8, "æ¨£æœ¬æ•¸": 120 },
                        "5å¹´æœŸ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 5.2, "å¹³å‡æº¢åƒ¹": 6.9, "æ¨£æœ¬æ•¸": 150 },
                        "7å¹´æœŸ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.5, "å¹³å‡æº¢åƒ¹": 5.5, "æ¨£æœ¬æ•¸": 16 }
                    },
                    "ä¿¡è©•": {
                        "2-3åˆ†": { "å¹³å‡æœ€ä½æº¢åƒ¹": 7.5, "å¹³å‡æº¢åƒ¹": 9.5, "æ¨£æœ¬æ•¸": 40 },
                        "4-5åˆ†": { "å¹³å‡æœ€ä½æº¢åƒ¹": 5.5, "å¹³å‡æº¢åƒ¹": 7.2, "æ¨£æœ¬æ•¸": 80 },
                        "6-7åˆ†": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.2, "å¹³å‡æº¢åƒ¹": 4.8, "æ¨£æœ¬æ•¸": 100 },
                        "8-9åˆ†": { "å¹³å‡æœ€ä½æº¢åƒ¹": 1.5, "å¹³å‡æº¢åƒ¹": 2.5, "æ¨£æœ¬æ•¸": 30 },
                        "BBBç´š": { "å¹³å‡æœ€ä½æº¢åƒ¹": 2.0, "å¹³å‡æº¢åƒ¹": 3.0, "æ¨£æœ¬æ•¸": 20 }
                    },
                    "ç™¼è¡Œè¦æ¨¡": {
                        "<10å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.5, "å¹³å‡æº¢åƒ¹": 6.0, "æ¨£æœ¬æ•¸": 80 },
                        "10-20å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 5.2, "å¹³å‡æº¢åƒ¹": 6.8, "æ¨£æœ¬æ•¸": 100 },
                        ">20å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.8, "å¹³å‡æº¢åƒ¹": 5.0, "æ¨£æœ¬æ•¸": 50 }
                    },
                    "è‚¡æœ¬": {
                        "<10å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 5.5, "å¹³å‡æº¢åƒ¹": 7.5, "æ¨£æœ¬æ•¸": 60 },
                        "10-50å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.5, "å¹³å‡æº¢åƒ¹": 6.0, "æ¨£æœ¬æ•¸": 150 },
                        ">50å„„": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.0, "å¹³å‡æº¢åƒ¹": 4.2, "æ¨£æœ¬æ•¸": 70 }
                    },
                    "è½‰æ›åƒ¹": {
                        "<100å…ƒ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 3.5, "å¹³å‡æº¢åƒ¹": 5.0, "æ¨£æœ¬æ•¸": 50 },
                        "100-200å…ƒ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.8, "å¹³å‡æº¢åƒ¹": 6.2, "æ¨£æœ¬æ•¸": 150 },
                        ">200å…ƒ": { "å¹³å‡æœ€ä½æº¢åƒ¹": 6.5, "å¹³å‡æº¢åƒ¹": 8.5, "æ¨£æœ¬æ•¸": 80 }
                    },
                    "ç†è«–åƒ¹": {
                        "<90": { "å¹³å‡æœ€ä½æº¢åƒ¹": 1.5, "å¹³å‡æº¢åƒ¹": 2.5, "æ¨£æœ¬æ•¸": 30 },
                        "90-100": { "å¹³å‡æœ€ä½æº¢åƒ¹": 2.8, "å¹³å‡æº¢åƒ¹": 4.0, "æ¨£æœ¬æ•¸": 60 },
                        "100-110": { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.5, "å¹³å‡æº¢åƒ¹": 6.2, "æ¨£æœ¬æ•¸": 100 },
                        "110-120": { "å¹³å‡æœ€ä½æº¢åƒ¹": 6.5, "å¹³å‡æº¢åƒ¹": 8.5, "æ¨£æœ¬æ•¸": 50 },
                        ">120": { "å¹³å‡æœ€ä½æº¢åƒ¹": 10.5, "å¹³å‡æº¢åƒ¹": 13.5, "æ¨£æœ¬æ•¸": 40 }
                    }
                }
            }
        };

        // ==========================================
        // åˆå§‹åŒ–é‚è¼¯
        // ==========================================
        window.addEventListener('load', function() {
            try {
                // å¡«å……ä¸‹æ‹‰é¸å–®
                const indSelect = document.getElementById('industry');
                Object.keys(MOCK_DB['çµ±è¨ˆæ•¸æ“š']['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']).forEach(k => {
                    let opt = document.createElement('option'); opt.value = k; opt.text = k; indSelect.add(opt);
                });

                const brkSelect = document.getElementById('broker');
                Object.keys(MOCK_DB['çµ±è¨ˆæ•¸æ“š']['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']).forEach(k => {
                    let opt = document.createElement('option'); opt.value = k; opt.text = k; brkSelect.add(opt);
                });

                // æ›´æ–°æ¨™é¡Œè³‡è¨Š
                document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | è³‡æ–™åº«å·²å°±ç·’`;
                document.getElementById('statsSummary').innerHTML = `
                    <div class="stat-box"><div class="number">${Object.keys(MOCK_DB['CBè³‡æ–™åº«']).length}</div><div class="label">CBè³‡æ–™åº«</div></div>
                    <div class="stat-box"><div class="number">${MOCK_DB['çµ±è¨ˆæ•¸æ“š']['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸']}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
                `;

                // éš±è— Loadingï¼Œé¡¯ç¤ºä¸»ç•«é¢
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                }, 500);

            } catch (e) {
                alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
                console.error(e);
            }
        });

        // ==========================================
        // æ ¸å¿ƒè¨ˆç®—åŠŸèƒ½
        // ==========================================
        function handleCalculation() {
            try {
                // 1. å–å¾—è³‡æ–™
                const getVal = (id) => document.getElementById(id).value;
                const data = {
                    cbName: getVal('cbName'),
                    industry: getVal('industry'),
                    broker: getVal('broker'),
                    issueSize: parseFloat(getVal('issueSize')),
                    conversionPrice: parseFloat(getVal('conversionPrice')),
                    years: parseInt(getVal('years')),
                    guarantee: getVal('guarantee'),
                    rating: getVal('rating'),
                    capital: parseFloat(getVal('capital')),
                    stockPrice: parseFloat(getVal('stockPrice'))
                };

                // 2. é©—è­‰è³‡æ–™
                if (!data.industry || isNaN(data.issueSize) || isNaN(data.conversionPrice) || isNaN(data.years) || !data.guarantee || !data.rating || isNaN(data.stockPrice)) {
                    alert("âš ï¸ è«‹æª¢æŸ¥æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼\n\nå»ºè­°æ‚¨é»æ“Šã€Œä¸€éµå¸¶å…¥ç¯„ä¾‹ã€æŒ‰éˆ•æ¸¬è©¦ã€‚");
                    return;
                }

                // 3. åŸ·è¡Œé‹ç®—
                const result = calculate(data);
                
                // 4. é¡¯ç¤ºçµæœ
                renderResult(result);

            } catch (e) {
                alert("é‹ç®—ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
                console.error(e);
            }
        }

        function calculate(data) {
            const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
            const stats = MOCK_DB['çµ±è¨ˆæ•¸æ“š']['ç¶­åº¦çµ±è¨ˆ'];
            
            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—æº¢åƒ¹æ•¸æ“š
            const getStats = (cat, key) => {
                // ç›´æ¥åŒ¹é…
                if (stats[cat][key]) return stats[cat][key];
                
                // ç¯„åœåŒ¹é… logic
                for (let k of Object.keys(stats[cat])) {
                    let cleanK = k.replace(/[^\d\.\-\<\>]/g, ''); // "10-20" or "<10"
                    let val = (cat === 'ç†è«–åƒ¹') ? theoPrice : (cat === 'ç™¼è¡Œè¦æ¨¡') ? data.issueSize : (cat === 'è‚¡æœ¬') ? data.capital : data.conversionPrice;
                    
                    if (cleanK.includes('-')) {
                        let [min, max] = cleanK.split('-').map(parseFloat);
                        if (val >= min && val < max) return { ...stats[cat][k], _rangeKey: k };
                    } else if (cleanK.startsWith('<')) {
                        if (val < parseFloat(cleanK.substring(1))) return { ...stats[cat][k], _rangeKey: k };
                    } else if (cleanK.startsWith('>')) {
                        if (val >= parseFloat(cleanK.substring(1))) return { ...stats[cat][k], _rangeKey: k };
                    }
                }
                // é è¨­å€¼
                return { "å¹³å‡æœ€ä½æº¢åƒ¹": 4.0, "å¹³å‡æº¢åƒ¹": 5.0, "_rangeKey": "-" };
            };

            // å–å¾—å„ç¶­åº¦åˆ†æ•¸
            const sInd = getStats('ç”¢æ¥­', data.industry);
            const sSize = getStats('ç™¼è¡Œè¦æ¨¡', data.issueSize); // éœ€ç¯„åœåŒ¹é…
            const sCap = getStats('è‚¡æœ¬', data.capital); // éœ€ç¯„åœåŒ¹é…
            const sYear = getStats('å¹´æœŸ', data.years + "å¹´æœŸ");
            const sGuar = getStats('æ“”ä¿', data.guarantee);
            
            // ä¿¡è©•ç‰¹æ®Šè™•ç†
            let rKey = data.rating;
            if (rKey !== 'BBB') {
                let v = parseInt(rKey);
                rKey = v<=3?'2-3åˆ†':v<=5?'4-5åˆ†':v<=7?'6-7åˆ†':'8-9åˆ†';
            }
            const sRate = getStats('ä¿¡è©•', rKey);
            const sConv = getStats('è½‰æ›åƒ¹', data.conversionPrice); // éœ€ç¯„åœåŒ¹é…
            const sTheo = getStats('ç†è«–åƒ¹', theoPrice);

            // æ¬Šé‡è¨ˆç®—
            const w = { theo: 0.3, guar: 0.2, ind: 0.15, size: 0.1, rate: 0.1, conv: 0.08, yr: 0.05, cap: 0.02 };
            
            const lowP = (v) => v["å¹³å‡æœ€ä½æº¢åƒ¹"] || 0;
            const compPremium = 
                lowP(sTheo)*w.theo + lowP(sGuar)*w.guar + lowP(sInd)*w.ind + 
                lowP(sSize)*w.size + lowP(sRate)*w.rate + lowP(sConv)*w.conv + 
                lowP(sYear)*w.yr + lowP(sCap)*w.cap;

            return {
                cbName: data.cbName,
                theoPrice: theoPrice,
                compPremium: compPremium,
                sInd, sSize, sCap, sYear, sGuar, sRate, sConv, sTheo,
                data: data,
                ranges: {
                    theo: sTheo._rangeKey || '-',
                    size: sSize._rangeKey || '-',
                    cap: sCap._rangeKey || '-',
                    conv: sConv._rangeKey || '-'
                }
            };
        }

        function renderResult(res) {
            document.getElementById('welcomeMsg').style.display = 'none';
            const resultDiv = document.getElementById('evaluationResult');
            resultDiv.className = 'evaluation-result active';

            const bidPrice = res.theoPrice * (1 + res.compPremium/100);
            const fmt = (n) => n.toFixed(2);
            const fmtP = (n) => `<span class="${n>0?'val-pos':'val-neg'}">${n.toFixed(2)}%</span>`;

            resultDiv.innerHTML = `
                <div class="result-header"><h2>${res.cbName || 'æœªå‘½åæ¨™çš„'}</h2><div class="subtitle">AIè©•ä¼°çµæœå®Œæˆ</div></div>
                
                <div class="detail-section">
                    <h3>ğŸ“Š æ ¸å¿ƒåƒ¹æ ¼åˆ†æ</h3>
                    <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;">
                        <div style="font-size:14px; color:#666;">ç†è«–åƒ¹æ ¼ (è½‰æ›åƒ¹å€¼)</div>
                        <div style="font-size:48px; font-weight:bold; color:#667eea;">${fmt(res.theoPrice)} <span style="font-size:18px;">å…ƒ</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ” AIæ¬Šé‡åˆ†æè¡¨</h3>
                    <table class="data-table">
                        <thead><tr><th>ç¶­åº¦</th><th>æ¢ä»¶/å€é–“</th><th>æ­·å²æœ€ä½æº¢åƒ¹</th><th>æ¬Šé‡</th></tr></thead>
                        <tbody>
                            <tr><td>ç†è«–åƒ¹ä½</td><td>${res.ranges.theo}</td><td>${fmtP(res.sTheo["å¹³å‡æœ€ä½æº¢åƒ¹"])}</td><td>30%</td></tr>
                            <tr><td>æ“”ä¿æƒ…æ³</td><td>${res.data.guarantee}</td><td>${fmtP(res.sGuar["å¹³å‡æœ€ä½æº¢åƒ¹"])}</td><td>20%</td></tr>
                            <tr><td>ç”¢æ¥­åˆ†é¡</td><td>${res.data.industry}</td><td>${fmtP(res.sInd["å¹³å‡æœ€ä½æº¢åƒ¹"])}</td><td>15%</td></tr>
                            <tr><td>ç™¼è¡Œè¦æ¨¡</td><td>${res.ranges.size}</td><td>${fmtP(res.sSize["å¹³å‡æœ€ä½æº¢åƒ¹"])}</td><td>10%</td></tr>
                            <tr><td>ä¿¡ç”¨è©•ç­‰</td><td>TCRI ${res.data.rating}</td><td>${fmtP(res.sRate["å¹³å‡æœ€ä½æº¢åƒ¹"])}</td><td>10%</td></tr>
                            <tr style="background:#e3f2fd; border-top:2px solid #1976D2;">
                                <td colspan="3" style="text-align:right; font-weight:bold; padding-right:15px;">ç¶œåˆé ä¼°æœ€ä½æº¢åƒ¹ç‡</td>
                                <td style="font-weight:bold; color:#d32f2f; font-size:16px;">${fmt(res.compPremium)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>ğŸ’¡ å»ºè­°æŠ•æ¨™åƒ¹æ ¼å€é–“</h3>
                    <div class="price-grid">
                        <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ (95%)</h4><div class="price">${fmt(bidPrice*0.95)}</div></div>
                        <div class="strategy-card balanced"><h4>âš–ï¸ åˆç† (100%)</h4><div class="price">${fmt(bidPrice)}</div></div>
                        <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ (105%)</h4><div class="price">${fmt(bidPrice*1.05)}</div></div>
                    </div>
                </div>
            `;
            
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function fillDemoData() {
            document.getElementById('cbName').value = "å°å…‰é›»ä¸ƒç¯„ä¾‹";
            document.getElementById('capital').value = "33.8";
            document.getElementById('industry').value = "é›»å­é›¶çµ„ä»¶æ¥­";
            document.getElementById('broker').value = "å‡±åŸºè­‰åˆ¸";
            document.getElementById('issueSize').value = "30";
            document.getElementById('conversionPrice').value = "490.7";
            document.getElementById('years').value = "5";
            document.getElementById('guarantee').value = "ç„¡æ“”ä¿";
            document.getElementById('rating').value = "4";
            document.getElementById('stockPrice').value = "560"; // è®“ç†è«–åƒ¹å¤§æ–¼100
        }
    </script>
</body>
</html>
