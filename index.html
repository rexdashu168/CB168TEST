<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex大叔 CB競拍數據分析工具 (修復版)</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f4f9; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h3 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .section { margin-bottom: 30px; padding: 15px; background: #eef; border-radius: 5px; }
        .input-group { margin-bottom: 15px; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        input[type="text"], input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        input[type="file"] { margin-top: 5px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        
        /* 表格樣式 */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        .status { color: green; font-weight: bold; margin-left: 10px; }
        .error { color: red; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Rex大叔 CB競拍數據分析工具</h1>

    <div class="section">
        <h3>1. 資料載入</h3>
        <div class="input-group">
            <label>競拍資料庫 (JSON):</label>
            <input type="file" id="fileAuctionData" accept=".json">
            <span id="statusAuction" class="status"></span>
        </div>
        <div class="input-group">
            <label>掛牌資料庫 (JSON):</label>
            <input type="file" id="fileNamesData" accept=".json">
            <span id="statusNames" class="status"></span>
        </div>
    </div>

    <div class="section">
        <h3>2. 參數輸入</h3>
        <div class="input-group">
            <label>股本 (億):</label>
            <input type="number" id="inputCapital" step="0.1" placeholder="例如: 10.5">
        </div>
        <div class="input-group">
            <label>發行規模 (億):</label>
            <input type="number" id="inputIssueSize" step="0.1" placeholder="例如: 5">
        </div>
        <div class="input-group">
            <label>發行券商:</label>
            <input type="text" id="inputBroker" placeholder="例如: 台新">
        </div>
        <button onclick="runAnalysis()">開始分析</button>
    </div>

    <div id="resultsArea" style="display:none;">
        
        <div class="section">
            <h3>1. 股本歷史統計 (依六區間)</h3>
            <table id="tableCapital">
                <thead>
                    <tr>
                        <th>區間範圍</th>
                        <th>樣本數</th>
                        <th>平均得標</th>
                        <th>平均溢價(%)</th>
                        <th>區間掛牌最高</th>
                        <th>區間掛牌最低</th>
                        <th>區間振幅</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h3>2. 發行券商歷史統計</h3>
            <table id="tableBroker">
                <thead>
                    <tr>
                        <th>券商名稱</th>
                        <th>歷史發行案件數</th>
                        <th>歷史最低得標</th>
                        <th>平均得標</th>
                        <th>平均溢價(%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h3>3. 發行條件(規模)歷史統計</h3>
            <table id="tableIssueSize">
                <thead>
                    <tr>
                        <th>區間範圍</th>
                        <th>區間最低得標</th>
                        <th>區間最低溢價(%)</th>
                        <th>區間平均得標</th>
                        <th>區間平均溢價(%)</th>
                        <th>區間掛牌最高</th>
                        <th>區間掛牌最低</th>
                        <th>區間振幅</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>

<script>
    let auctionData = []; // 競拍原始資料
    let namesData = {};   // 掛牌資料庫

    // 讀取檔案邏輯
    document.getElementById('fileAuctionData').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // 兼容兩種格式：直接是陣列 或 包在 "競拍原始資料" 裡
                if (json["競拍原始資料"]) {
                    auctionData = json["競拍原始資料"];
                } else if (Array.isArray(json)) {
                    auctionData = json;
                } else {
                    throw new Error("格式不符");
                }
                document.getElementById('statusAuction').innerText = "✅ 載入成功 (" + auctionData.length + " 筆)";
            } catch (err) {
                document.getElementById('statusAuction').innerText = "❌ 格式錯誤";
                document.getElementById('statusAuction').className = "error";
            }
        };
        reader.readAsText(file);
    });

    document.getElementById('fileNamesData').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // 兼容：如果是 cb_data_integrated 格式，裡面可能有 "CB資料庫"
                if (json["CB資料庫"]) {
                    namesData = json["CB資料庫"];
                } else {
                    namesData = json; // 假設是 cb_names_database.json
                }
                document.getElementById('statusNames').innerText = "✅ 載入成功";
            } catch (err) {
                document.getElementById('statusNames').innerText = "❌ 格式錯誤";
                document.getElementById('statusNames').className = "error";
            }
        };
        reader.readAsText(file);
    });

    // === 主要分析邏輯 ===
    function runAnalysis() {
        if (auctionData.length === 0) {
            alert("請先上傳競拍資料庫！");
            return;
        }

        const targetCap = parseFloat(document.getElementById('inputCapital').value) || 0;
        const targetSize = parseFloat(document.getElementById('inputIssueSize').value) || 0;
        const targetBroker = document.getElementById('inputBroker').value.trim();

        document.getElementById('resultsArea').style.display = 'block';

        // 執行三個運算
        updateCapitalStats(targetCap);
        updateBrokerStats(targetBroker);
        updateIssueSizeStats(targetSize);
    }

    // 1. 股本歷史統計邏輯 (含修復：平均數據、區間掛牌)
    function updateCapitalStats(targetCap) {
        const tbody = document.querySelector('#tableCapital tbody');
        tbody.innerHTML = "";

        // 提取所有股本
        const caps = auctionData.map(d => parseFloat(d['股本'] || 0)).filter(v => v > 0);
        if (caps.length === 0) return;

        const minCap = Math.min(...caps);
        const maxCap = Math.max(...caps);
        const range = maxCap - minCap;
        const intervalSize = range / 6;

        // 找出目標落在哪個區間
        let targetIndex = Math.floor((targetCap - minCap) / intervalSize);
        if (targetIndex < 0) targetIndex = 0;
        if (targetIndex > 5) targetIndex = 5;

        const rangeStart = minCap + (targetIndex * intervalSize);
        const rangeEnd = rangeStart + intervalSize;

        // 篩選該區間資料
        const matchedCBs = auctionData.filter(d => {
            const val = parseFloat(d['股本'] || 0);
            return val >= rangeStart && val <= (targetIndex === 5 ? maxCap : rangeEnd);
        });

        // 統計
        let totalWin = 0, totalPrem = 0, count = 0;
        let highList = -Infinity, lowList = Infinity;

        matchedCBs.forEach(d => {
            // 處理競拍數據
            const w = parseFloat(d['平均得標']);
            const p = parseFloat(d['平均溢價']);
            if (!isNaN(w) && w > 0) { totalWin += w; count++; }
            if (!isNaN(p)) { totalPrem += p; } // 溢價可能是 0

            // 處理掛牌數據 (需連結 namesData)
            const code = d['CB代號'] || d['代號']; // 嘗試不同欄位名
            if (code && namesData[code]) {
                const h = parseFloat(namesData[code]['掛牌最高'] || 0);
                const l = parseFloat(namesData[code]['掛牌最低'] || 0);
                if (h > 0 && h > highList) highList = h;
                if (l > 0 && l < lowList) lowList = l;
            }
        });

        const row = `<tr>
            <td>${rangeStart.toFixed(1)} - ${rangeEnd.toFixed(1)} 億</td>
            <td>${matchedCBs.length}</td>
            <td>${count > 0 ? (totalWin/count).toFixed(2) : "-"}</td>
            <td>${count > 0 ? (totalPrem/count).toFixed(2) : "-"}</td>
            <td>${highList !== -Infinity ? highList : "-"}</td>
            <td>${lowList !== Infinity ? lowList : "-"}</td>
            <td>${(highList !== -Infinity && lowList !== Infinity) ? (highList - lowList).toFixed(2) : "-"}</td>
        </tr>`;
        tbody.innerHTML = row;
    }

    // 2. 券商歷史統計邏輯 (含修復：最低得標空白、新增平均數據)
    function updateBrokerStats(targetBroker) {
        const tbody = document.querySelector('#tableBroker tbody');
        tbody.innerHTML = "";

        if (!targetBroker) return;

        const brokerCBs = auctionData.filter(d => (d['發行券商'] || d['承銷券商']) === targetBroker);
        
        if (brokerCBs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>查無此券商資料</td></tr>";
            return;
        }

        let totalWin = 0, totalPrem = 0, count = 0;
        let minWin = Infinity;

        brokerCBs.forEach(d => {
            const avgW = parseFloat(d['平均得標']);
            const avgP = parseFloat(d['平均溢價']);
            const lowW = parseFloat(d['最低得標']);

            if (!isNaN(avgW) && avgW > 0) {
                totalWin += avgW;
                count++;
            }
            if (!isNaN(avgP)) {
                totalPrem += avgP;
            }
            // 修復：確保抓到數值最小的最低得標
            if (!isNaN(lowW) && lowW > 0 && lowW < minWin) {
                minWin = lowW;
            }
        });

        const row = `<tr>
            <td>${targetBroker}</td>
            <td>${brokerCBs.length}</td>
            <td>${minWin !== Infinity ? minWin.toFixed(2) : "-"}</td>
            <td>${count > 0 ? (totalWin/count).toFixed(2) : "-"}</td>
            <td>${count > 0 ? (totalPrem/count).toFixed(2) : "-"}</td>
        </tr>`;
        tbody.innerHTML = row;
    }

    // 3. 發行條件(規模)歷史統計 (含新增：六區間、完整競拍與掛牌數據)
    function updateIssueSizeStats(targetSize) {
        const tbody = document.querySelector('#tableIssueSize tbody');
        tbody.innerHTML = "";

        const sizes = auctionData.map(d => parseFloat(d['發行規模'] || 0)).filter(v => v > 0);
        if (sizes.length === 0) return;

        const minSize = Math.min(...sizes);
        const maxSize = Math.max(...sizes);
        const range = maxSize - minSize;
        const intervalSize = range / 6;

        let targetIndex = Math.floor((targetSize - minSize) / intervalSize);
        if (targetIndex < 0) targetIndex = 0;
        if (targetIndex > 5) targetIndex = 5;

        const rangeStart = minSize + (targetIndex * intervalSize);
        const rangeEnd = rangeStart + intervalSize;

        const matchedCBs = auctionData.filter(d => {
            const val = parseFloat(d['發行規模'] || 0);
            return val >= rangeStart && val <= (targetIndex === 5 ? maxSize : rangeEnd);
        });

        // 統計該區間的極值與平均
        let intervalLowWin = Infinity, intervalLowPrem = Infinity;
        let sumAvgWin = 0, sumAvgPrem = 0, count = 0;
        let highList = -Infinity, lowList = Infinity;

        matchedCBs.forEach(d => {
            const lw = parseFloat(d['最低得標']);
            const lp = parseFloat(d['最低溢價']);
            const aw = parseFloat(d['平均得標']);
            const ap = parseFloat(d['平均溢價']);

            if (!isNaN(lw) && lw > 0 && lw < intervalLowWin) intervalLowWin = lw;
            if (!isNaN(lp) && lp < intervalLowPrem) intervalLowPrem = lp; // 溢價可能為負或0，需注意

            if (!isNaN(aw) && aw > 0) {
                sumAvgWin += aw;
                count++;
            }
            if (!isNaN(ap)) sumAvgPrem += ap;

            // 掛牌
            const code = d['CB代號'] || d['代號'];
            if (code && namesData[code]) {
                const h = parseFloat(namesData[code]['掛牌最高'] || 0);
                const l = parseFloat(namesData[code]['掛牌最低'] || 0);
                if (h > 0 && h > highList) highList = h;
                if (l > 0 && l < lowList) lowList = l;
            }
        });

        const row = `<tr>
            <td>${rangeStart.toFixed(1)} - ${rangeEnd.toFixed(1)} 億</td>
            <td>${intervalLowWin !== Infinity ? intervalLowWin.toFixed(2) : "-"}</td>
            <td>${intervalLowPrem !== Infinity ? intervalLowPrem.toFixed(2) : "-"}</td>
            <td>${count > 0 ? (sumAvgWin/count).toFixed(2) : "-"}</td>
            <td>${count > 0 ? (sumAvgPrem/count).toFixed(2) : "-"}</td>
            <td>${highList !== -Infinity ? highList : "-"}</td>
            <td>${lowList !== Infinity ? lowList : "-"}</td>
            <td>${(highList !== -Infinity && lowList !== Infinity) ? (highList - lowList).toFixed(2) : "-"}</td>
        </tr>`;
        tbody.innerHTML = row;
    }
</script>

</body>
</html>
